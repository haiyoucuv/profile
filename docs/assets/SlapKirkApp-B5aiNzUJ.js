const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-qNEX1PJU.js","./graph_model-Btsq6Nul.js","./index-B-KT0xZn.js","./index-BMPpMFjp.css","./hand-pose-detection.esm-DwCkUoCh.js"])))=>i.map(i=>d[i]);
import{_ as D,k as F,b as R,R as L,A as $,r as m,j as l}from"./index-B-KT0xZn.js";import{V as H,W as G,a as q}from"./VirtualApp-C1dA06xo.js";var w=(a=>(a.NONE="none",a.READY="ready",a.SLAP="slap",a.FIST="fist",a.PEACE="peace",a))(w||{});class V{model=null;videoElement=null;canvas=null;ctx=null;isInitialized=!1;isDetecting=!1;gestureHistory=[];HISTORY_SIZE=5;lastDetectionResult=[];debugModeEnabled=!1;lastDebugUpdate=0;advancedDebugMode=!1;SLAP_VELOCITY_THRESHOLD=.15;CONFIDENCE_THRESHOLD=.7;async initialize(t={width:640,height:480,facingMode:"user"}){try{if(console.log("初始化AI手势识别引擎..."),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("浏览器不支持摄像头访问");this.videoElement=document.createElement("video"),this.videoElement.width=t.width,this.videoElement.height=t.height,this.videoElement.autoplay=!0,this.videoElement.muted=!0,this.videoElement.playsInline=!0,this.canvas=document.createElement("canvas"),this.canvas.width=t.width,this.canvas.height=t.height,this.ctx=this.canvas.getContext("2d");const e=await navigator.mediaDevices.getUserMedia({video:{width:t.width,height:t.height,facingMode:t.facingMode}});return this.videoElement.srcObject=e,await this.videoElement.play(),await this.loadModel(),this.isInitialized=!0,console.log("AI手势识别引擎初始化成功"),!0}catch(e){return console.error("初始化AI引擎失败:",e),!1}}async loadModel(){try{console.log("开始加载MediaPipe Hands模型...");const[t,e]=await Promise.all([D(()=>import("./index-qNEX1PJU.js"),__vite__mapDeps([0,1,2,3]),import.meta.url),D(()=>import("./hand-pose-detection.esm-DwCkUoCh.js"),__vite__mapDeps([4,2,3,1]),import.meta.url)]);await t.ready(),console.log("TensorFlow.js后端就绪:",t.getBackend()),this.model=await e.createDetector(e.SupportedModels.MediaPipeHands,{runtime:"tfjs",modelType:"lite",maxHands:2}),console.log("MediaPipe Hands模型加载成功")}catch(t){console.error("模型加载失败，使用模拟模式:",t),this.model=null,await new Promise(e=>setTimeout(e,1e3))}}async startDetection(){!this.isInitialized||this.isDetecting||(this.isDetecting=!0,this.detectionLoop())}stopDetection(){this.isDetecting=!1}async detectionLoop(){if(!(!this.isDetecting||!this.videoElement)){try{const t=await this.detectGesture();this.addToHistory(t),t.type!=="none"&&this.onGestureDetected?.(t),this.debugModeEnabled&&Date.now()-this.lastDebugUpdate>100&&(this.updateDebugCanvas(),this.lastDebugUpdate=Date.now())}catch(t){console.error("手势检测错误:",t)}setTimeout(()=>this.detectionLoop(),33)}}async detectGesture(){if(!this.videoElement)return{type:"none",confidence:0};try{if(this.model){const t=await this.model.estimateHands(this.videoElement,{flipHorizontal:!0});return this.lastDetectionResult=t,t&&t.length>0?this.classifyGesture(t):{type:"none",confidence:0}}else return this.simulateGestureDetection()}catch(t){return console.error("手势检测失败:",t),{type:"none",confidence:0}}}simulateGestureDetection(){const t=this.generateSimulatedHandData();this.lastDetectionResult=[t];const e=Math.random();return e<.05?{type:"slap",confidence:.8+Math.random()*.2,landmarks:t.landmarks,velocity:{x:(Math.random()-.5)*.4,y:(Math.random()-.5)*.2,magnitude:.15+Math.random()*.1}}:e<.6?{type:"ready",confidence:.7+Math.random()*.3,landmarks:t.landmarks}:{type:"none",confidence:.6+Math.random()*.2,landmarks:t.landmarks}}generateSimulatedHandData(){console.log("开始生成模拟手部数据...");const t=[],e=Date.now()/1e3,s=.5+Math.sin(e*.5)*.1,i=.5+Math.cos(e*.3)*.1;t[0]={x:s,y:i,z:0},console.log(`手腕位置: (${s.toFixed(3)}, ${i.toFixed(3)})`);const n=[{base:[.45,.45],joints:4,spread:.08},{base:[.48,.35],joints:4,spread:.12},{base:[.5,.3],joints:4,spread:.15},{base:[.52,.35],joints:4,spread:.12},{base:[.55,.4],joints:4,spread:.1}];let o=1;for(n.forEach((h,f)=>{const g=s+(h.base[0]-.5),d=i+(h.base[1]-.5);for(let u=0;u<h.joints;u++){const p=(u+1)/h.joints,x=f*.3+Math.sin(e+f)*.2,y=g+Math.cos(x)*h.spread*p,v=d+Math.sin(x)*h.spread*p,b=Math.sin(e*2+f+u)*.02;t[o]={x:y,y:v,z:b},o++}});t.length<21;)t.push({x:s,y:i,z:0});console.log(`模拟手部数据生成完成，关键点数量: ${t.length}`);const c={landmarks:t,keypoints:t,score:.85+Math.sin(e)*.1,handedness:{categoryName:"Left",displayName:"左手 (模拟)",score:.9+Math.cos(e*.5)*.05}};return console.log("模拟手部数据:",c),c}classifyGesture(t){if(!t||t.length===0)return{type:"none",confidence:0};const e=t[0],s=e.keypoints||e.landmarks,i=e.score||e.handedness?.score||.8,n=s.map(c=>({x:c.x,y:c.y,z:c.z||0})),o=this.calculateVelocity(n);return this.isPeaceSign(n)?{type:"peace",confidence:i,landmarks:n,velocity:o}:this.isFist(n)?{type:"fist",confidence:i,landmarks:n,velocity:o}:this.isPalmOpen(n)?o.magnitude>this.SLAP_VELOCITY_THRESHOLD&&Math.abs(o.x)>Math.abs(o.y)?{type:"slap",confidence:i,landmarks:n,velocity:o}:{type:"ready",confidence:i,landmarks:n,velocity:o}:{type:"none",confidence:0}}isPalmOpen(t){if(!t||t.length<21)return!1;const e=[4,8,12,16,20],s=[3,6,10,14,18],i=t[0];let n=0;for(let o=0;o<e.length;o++){const c=e[o],h=s[o];if(c<t.length&&h<t.length){const f=t[c],g=t[h],d=Math.sqrt(Math.pow(f.x-g.x,2)+Math.pow(f.y-g.y,2));Math.sqrt(Math.pow(f.x-i.x,2)+Math.pow(f.y-i.y,2))>d*1.2&&n++}}return n>=3}isFist(t){if(!t||t.length<21)return!1;const e=[4,8,12,16,20],s=t[9];let i=0;for(const n of e)if(n<t.length){const o=t[n];Math.sqrt(Math.pow(o.x-s.x,2)+Math.pow(o.y-s.y,2))<.1&&i++}return i>=4}isPeaceSign(t){if(!t||t.length<21)return!1;const e=t[8],s=t[12],i=t[16],n=t[20],o=t[4],c=t[9],h=Math.sqrt(Math.pow(e.x-c.x,2)+Math.pow(e.y-c.y,2)),f=Math.sqrt(Math.pow(s.x-c.x,2)+Math.pow(s.y-c.y,2)),g=Math.sqrt(Math.pow(i.x-c.x,2)+Math.pow(i.y-c.y,2)),d=Math.sqrt(Math.pow(n.x-c.x,2)+Math.pow(n.y-c.y,2)),u=Math.sqrt(Math.pow(o.x-c.x,2)+Math.pow(o.y-c.y,2)),p=h>.15,x=f>.15,y=g<.12,v=d<.12,b=u<.12;return p&&x&&y&&v&&b}calculateVelocity(t){if(this.gestureHistory.length<2||!t||t.length===0)return{x:0,y:0,magnitude:0};const e=9,s=t[e]||t[0];let i=null;for(let g=this.gestureHistory.length-1;g>=0;g--){const d=this.gestureHistory[g].landmarks;if(d&&d.length>e){i=d[e]||d[0];break}}if(!i)return{x:0,y:0,magnitude:0};const n=s.x-i.x,o=s.y-i.y,c=Math.sqrt(n*n+o*o),h=.7,f=this.gestureHistory[this.gestureHistory.length-1].velocity;return f?{x:h*n+(1-h)*f.x,y:h*o+(1-h)*f.y,magnitude:h*c+(1-h)*f.magnitude}:{x:n,y:o,magnitude:c}}addToHistory(t){this.gestureHistory.push(t),this.gestureHistory.length>this.HISTORY_SIZE&&this.gestureHistory.shift()}getVideoElement(){return this.videoElement}getDebugCanvas(){return this.canvas}updateDebugCanvas(){if(!this.ctx||!this.canvas||!this.debugModeEnabled){console.log("调试更新跳过:",{ctx:!!this.ctx,canvas:!!this.canvas,debugMode:this.debugModeEnabled});return}try{console.log("开始更新调试画布..."),this.testCanvasDrawing(),this.drawFullHandLandmarks()}catch(t){console.error("调试画布更新失败:",t)}}testCanvasDrawing(){if(!this.ctx||!this.canvas){console.log("Canvas测试失败: 没有ctx或canvas");return}console.log(`Canvas尺寸: ${this.canvas.width} x ${this.canvas.height}`),this.ctx.fillStyle="#FF0000",this.ctx.fillRect(50,50,100,100),console.log("红色方块已绘制在 (50,50) 尺寸 100x100"),this.ctx.fillStyle="#00FF00",this.ctx.beginPath(),this.ctx.arc(200,100,30,0,2*Math.PI),this.ctx.fill(),console.log("绿色圆圈已绘制在 (200,100) 半径 30"),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 20px Arial",this.ctx.fillText("Canvas测试",50,200),console.log("文字已绘制")}drawFullHandLandmarks(){if(!this.ctx||!this.canvas){console.log("调试绘制失败: Canvas或Context不可用");return}try{this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),console.log(`调试绘制: 检测到${this.lastDetectionResult.length}只手`),this.lastDetectionResult&&this.lastDetectionResult.length>0?this.lastDetectionResult.forEach((t,e)=>{console.log(`绘制第${e+1}只手，关键点数量:`,t.landmarks?.length||t.keypoints?.length||0),this.drawHandWithAllLandmarks(t,e)}):console.log("调试绘制: 没有手部数据"),this.drawDebugInfoPanel()}catch(t){console.error("完整手部关键点绘制失败:",t)}}drawHandWithAllLandmarks(t,e){if(!this.ctx||!this.canvas){console.log("绘制手部失败: 没有ctx或canvas");return}try{const s=t.keypoints||t.landmarks;if(console.log(`手部数据检查 - Hand ${e}:`,{hasKeypoints:!!t.keypoints,hasLandmarks:!!t.landmarks,landmarksLength:s?.length||0,firstPoint:s?.[0]}),!s||s.length===0){console.log(`手部 ${e} 没有关键点数据`);return}console.log(`开始绘制手部 ${e}，关键点数量: ${s.length}`),this.ctx.fillStyle="#FFFF00",this.ctx.fillRect(300,50+e*50,50,30),this.ctx.fillStyle="#000000",this.ctx.font="12px Arial",this.ctx.fillText(`Hand ${e}`,305,70+e*50);const i=[[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[5,9],[9,10],[10,11],[11,12],[9,13],[13,14],[14,15],[15,16],[13,17],[17,18],[18,19],[19,20],[0,17]],n=["#00FF44","#FF4400","#4400FF","#FFAA00"],o=n[e%n.length];this.ctx.strokeStyle=o,this.ctx.lineWidth=4,this.ctx.globalAlpha=.9,this.ctx.lineCap="round",i.forEach(([d,u])=>{if(d<s.length&&u<s.length){const p=s[d],x=s[u],y=this.canvas.width-p.x,v=p.y,b=this.canvas.width-x.x,T=x.y;this.ctx.beginPath(),this.ctx.moveTo(y,v),this.ctx.lineTo(b,T),this.ctx.stroke()}}),this.ctx.fillStyle=o,this.ctx.globalAlpha=1,s.forEach((d,u)=>{const p=this.canvas.width-d.x,x=d.y;let y=4;u===0?y=12:[4,8,12,16,20].includes(u)?y=8:[2,3,6,7,10,11,14,15,18,19].includes(u)&&(y=6),this.ctx.fillStyle=o,this.ctx.beginPath(),this.ctx.arc(p,x,y,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(p,x,y,0,2*Math.PI),this.ctx.stroke(),[0,4,8,12,16,20].includes(u)&&(this.ctx.fillStyle="#000000",this.ctx.font="bold 10px Arial",this.ctx.textAlign="center",this.ctx.fillText(u.toString(),p,x+3),this.ctx.textAlign="left")}),console.log(`手部 ${e} 所有关键点绘制完成`);const c=t.score||t.handedness?.score||0,h=t.handedness?.categoryName||t.handedness?.displayName||`Hand ${e+1}`;this.ctx.fillStyle=o,this.ctx.font="bold 14px Arial",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2;const f=`${h} ${(c*100).toFixed(0)}%`,g=30+e*20;this.ctx.strokeText(f,15,g),this.ctx.fillText(f,15,g)}catch(s){console.error(`绘制第${e+1}只手失败:`,s)}}drawDebugInfoPanel(){if(!(!this.ctx||!this.canvas))try{const t=[`检测到手数: ${this.lastDetectionResult.length}`,`模型: ${this.model?"TensorFlow.js":"模拟模式"}`];this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(this.canvas.width-200,10,190,50),this.ctx.fillStyle="#00D4FF",this.ctx.font="bold 11px Arial",t.forEach((e,s)=>{this.ctx.fillText(e,this.canvas.width-190,28+s*16)})}catch(t){console.error("调试信息面板绘制失败:",t)}}drawBasicDebugInfo(){if(!(!this.ctx||!this.canvas))try{const t=["调试模式: 基础模式",`检测到手数: ${this.lastDetectionResult.length}`,`模型状态: ${this.model?"TensorFlow.js":"模拟模式"}`,`画布尺寸: ${this.canvas.width}x${this.canvas.height}`,"提示: 双击开启关键点显示"];this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(10,10,320,130),this.ctx.fillStyle="#00D4FF",this.ctx.font="bold 14px Arial",t.forEach((e,s)=>{this.ctx.fillText(e,15,35+s*20)}),this.lastDetectionResult&&this.lastDetectionResult.length>0?(this.ctx.fillStyle="#00FF44",this.ctx.font="bold 16px Arial",this.ctx.fillText("✋ 检测到手部",15,155),this.lastDetectionResult.forEach((e,s)=>{const i=e.score||e.handedness?.score||0,n=e.handedness?.displayName||`Hand ${s+1}`;this.ctx.fillStyle=s===0?"#00FF44":"#FF4400",this.ctx.font="12px Arial",this.ctx.fillText(`${n}: ${(i*100).toFixed(1)}%`,150,155+s*15)}),this.advancedDebugMode&&this.drawSimplifiedLandmarks()):(this.ctx.fillStyle="#FFAA00",this.ctx.font="14px Arial",this.ctx.fillText("👋 请将手放在摄像头前",15,155))}catch(t){console.error("基础调试信息绘制失败:",t)}}drawSimplifiedLandmarks(){if(!(!this.ctx||!this.canvas||!this.lastDetectionResult))try{this.lastDetectionResult.forEach((t,e)=>{const s=t.keypoints||t.landmarks;if(!s||s.length===0)return;const i=[0,4,8,12,16,20],n=["#00FF44","#FF4400","#4400FF","#FFFF00"],o=n[e%n.length];this.ctx.fillStyle=o,this.ctx.strokeStyle=o,this.ctx.lineWidth=2,i.forEach((c,h)=>{if(c<s.length){const f=s[c],g=f.x*this.canvas.width,d=f.y*this.canvas.height;this.ctx.beginPath(),this.ctx.arc(g,d,c===0?8:5,0,2*Math.PI),this.ctx.fill(),c===0&&(this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 10px Arial",this.ctx.fillText("手腕",g+10,d-10),this.ctx.fillStyle=o)}})})}catch(t){console.error("简化关键点绘制失败:",t)}}drawSingleHand(t,e){if(!(!this.ctx||!this.canvas))try{const s=t.keypoints||t.landmarks;if(!s||s.length===0)return;const i=[[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[5,9],[9,10],[10,11],[11,12],[9,13],[13,14],[14,15],[15,16],[13,17],[17,18],[18,19],[19,20],[0,17]],n=["#00FF44","#FF4400","#4400FF","#FFFF00"],o=n[e%n.length];this.ctx.strokeStyle=o,this.ctx.fillStyle=o,this.ctx.lineWidth=3,this.ctx.beginPath(),i.forEach(([d,u])=>{if(d<s.length&&u<s.length){const p=s[d],x=s[u],y=p.x*this.canvas.width,v=p.y*this.canvas.height,b=x.x*this.canvas.width,T=x.y*this.canvas.height;this.ctx.moveTo(y,v),this.ctx.lineTo(b,T)}}),this.ctx.stroke(),s.forEach((d,u)=>{const p=d.x*this.canvas.width,x=d.y*this.canvas.height;let y=4;u===0?y=8:[4,8,12,16,20].includes(u)&&(y=6),this.ctx.beginPath(),this.ctx.arc(p,x,y,0,2*Math.PI),this.ctx.fill(),[0,4,8,12,16,20].includes(u)&&(this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 12px Arial",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=3,this.ctx.strokeText(u.toString(),p+8,x-8),this.ctx.fillText(u.toString(),p+8,x-8),this.ctx.fillStyle=o,this.ctx.strokeStyle=o,this.ctx.lineWidth=3)});const c=t.score||t.handedness?.score||0,h=t.handedness?.categoryName||t.handedness?.displayName||`Hand ${e+1}`;this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Arial",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=3;const f=`${h} (${(c*100).toFixed(1)}%)`,g=30+e*25;this.ctx.strokeText(f,10,g),this.ctx.fillText(f,10,g)}catch(s){console.error(`绘制第${e+1}只手失败:`,s)}}drawDebugInfo(){if(!this.ctx||!this.canvas)return;const t=[`检测到手数: ${this.lastDetectionResult.length}`,"检测频率: ~30fps",`模型状态: ${this.model?"TensorFlow.js":"模拟模式"}`,`分辨率: ${this.canvas.width}x${this.canvas.height}`];this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(10,this.canvas.height-120,300,110),this.ctx.fillStyle="#00D4FF",this.ctx.font="bold 12px Arial",t.forEach((s,i)=>{this.ctx.fillText(s,15,this.canvas.height-95+i*18)});const e=["● 0: 手腕  ● 4,8,12,16,20: 指尖","● 绿色: 第一只手  ● 红色: 第二只手"];this.ctx.fillStyle="#FFFFFF",this.ctx.font="10px Arial",e.forEach((s,i)=>{this.ctx.fillText(s,15,this.canvas.height-25+i*12)})}drawHandLandmarks(t,e){this.updateDebugCanvas()}setDebugMode(t,e=!1){if(console.log(`设置调试模式: ${t}, 高级模式: ${e}`),this.debugModeEnabled=t,this.advancedDebugMode=e,t){if(console.log("调试模式已启用，准备绘制手部关键点..."),this.lastDetectionResult.length===0){const s=this.generateSimulatedHandData();this.lastDetectionResult=[s],console.log("生成测试手部数据")}setTimeout(()=>{this.lastDebugUpdate=0,this.updateDebugCanvas()},100)}else this.ctx&&this.canvas&&requestAnimationFrame(()=>{this.ctx&&this.canvas&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)})}enableAdvancedDebug(){this.debugModeEnabled&&(this.advancedDebugMode=!0,console.log("启用高级调试模式（关键点显示）"),this.updateDebugCanvas())}disableAdvancedDebug(){this.advancedDebugMode=!1,console.log("关闭高级调试模式"),this.debugModeEnabled&&this.updateDebugCanvas()}getDebugMode(){return this.debugModeEnabled}getAdvancedDebugMode(){return this.advancedDebugMode}onGestureDetected;dispose(){this.stopDetection(),this.videoElement?.srcObject&&this.videoElement.srcObject.getTracks().forEach(e=>e.stop()),this.videoElement=null,this.canvas=null,this.ctx=null,this.model=null,this.isInitialized=!1}}var S=(a=>(a.LOADING="loading",a.CALIBRATING="calibrating",a.READY="ready",a.PLAYING="playing",a.PAUSED="paused",a))(S||{});class O{stats={totalSlaps:0,currentCombo:0,maxCombo:0,accuracy:0,sessionTime:0};gameState="loading";sessionStartTime=0;lastSlapTime=0;COMBO_TIMEOUT=2e3;onStatsUpdate;onGameStateChange;onSlapEffect;constructor(){this.loadFromStorage()}startSession(){this.gameState="playing",this.sessionStartTime=Date.now(),this.onGameStateChange?.(this.gameState),console.log("游戏会话开始")}pauseGame(){this.gameState==="playing"&&(this.gameState="paused",this.updateSessionTime(),this.onGameStateChange?.(this.gameState))}resumeGame(){this.gameState==="paused"&&(this.gameState="playing",this.sessionStartTime=Date.now()-this.stats.sessionTime*1e3,this.onGameStateChange?.(this.gameState))}handleGesture(t){if(this.gameState==="playing"){switch(t.type){case w.SLAP:this.handleSlap(t);break;case w.FIST:this.handleReset();break;case w.PEACE:this.handleSpecialGesture();break}this.updateSessionTime(),this.saveToStorage()}}handleSlap(t){const e=Date.now(),s=t.velocity?.magnitude||.5;this.stats.totalSlaps++,e-this.lastSlapTime<this.COMBO_TIMEOUT?this.stats.currentCombo++:this.stats.currentCombo=1,this.stats.currentCombo>this.stats.maxCombo&&(this.stats.maxCombo=this.stats.currentCombo),this.lastSlapTime=e;const i=Math.min(s*2,1);this.onSlapEffect?.(i),this.onStatsUpdate?.(this.stats),console.log(`扇击！强度: ${s.toFixed(2)}, 连击: ${this.stats.currentCombo}`)}handleReset(){this.stats.currentCombo=0,this.onStatsUpdate?.(this.stats),console.log("重置连击")}handleSpecialGesture(){console.log("触发特殊效果！"),this.onSlapEffect?.(1.5)}updateSessionTime(){this.gameState==="playing"&&this.sessionStartTime>0&&(this.stats.sessionTime=(Date.now()-this.sessionStartTime)/1e3)}saveToStorage(){try{const t={stats:this.stats};localStorage.setItem("slapkirk_game_data",JSON.stringify(t))}catch(t){console.warn("保存游戏数据失败:",t)}}loadFromStorage(){try{const t=localStorage.getItem("slapkirk_game_data");if(t){const e=JSON.parse(t);e.stats&&(this.stats={...this.stats,...e.stats},this.stats.currentCombo=0,this.stats.sessionTime=0)}}catch(t){console.warn("加载游戏数据失败:",t)}}resetAllData(){this.stats={totalSlaps:0,currentCombo:0,maxCombo:0,accuracy:0,sessionTime:0},this.saveToStorage(),this.onStatsUpdate?.(this.stats),console.log("所有数据已重置")}getStats(){return this.updateSessionTime(),{...this.stats}}getGameState(){return this.gameState}setGameState(t){this.gameState=t,this.onGameStateChange?.(t)}formatTime(t){const e=Math.floor(t/60),s=Math.floor(t%60);return`${e.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}getSlapRate(){return this.stats.sessionTime===0?0:this.stats.totalSlaps/this.stats.sessionTime*60}}class _{currentAnimation=null;frameTimer=null;frameIndex=0;isPlaying=!1;async playVideoAnimation(t,e,s){this.stop();const i=document.createElement("video");i.src=e.videoPath,i.style.width="100%",i.style.height="100%",i.style.objectFit="contain",i.muted=!0,i.loop=e.loop||!1,i.autoplay=e.autoplay!==!1,t.innerHTML="",t.appendChild(i),this.currentAnimation=i,this.isPlaying=!0,i.addEventListener("ended",()=>{e.loop||(this.isPlaying=!1,s?.())});try{await i.play()}catch(n){console.warn("视频播放失败:",n),this.isPlaying=!1}}playFrameAnimation(t,e,s){if(this.stop(),e.framePaths.length===0){s?.();return}const i=document.createElement("img");i.style.width="100%",i.style.height="100%",i.style.objectFit="contain",t.innerHTML="",t.appendChild(i),this.currentAnimation=i,this.isPlaying=!0,this.frameIndex=0;const o=1e3/(e.frameRate||24),c=()=>{if(this.isPlaying){if(this.frameIndex>=e.framePaths.length)if(e.loop)this.frameIndex=0;else{this.isPlaying=!1,s?.();return}i.src=e.framePaths[this.frameIndex],this.frameIndex++,this.frameTimer=window.setTimeout(c,o)}};c()}stop(){this.isPlaying=!1,this.frameTimer&&(clearTimeout(this.frameTimer),this.frameTimer=null),this.currentAnimation&&(this.currentAnimation instanceof HTMLVideoElement&&(this.currentAnimation.pause(),this.currentAnimation.currentTime=0),this.currentAnimation=null)}pause(){this.isPlaying=!1,this.currentAnimation instanceof HTMLVideoElement&&this.currentAnimation.pause(),this.frameTimer&&(clearTimeout(this.frameTimer),this.frameTimer=null)}resume(){this.currentAnimation instanceof HTMLVideoElement&&(this.currentAnimation.play(),this.isPlaying=!0)}getPlayingState(){return this.isPlaying}destroy(){this.stop()}}class j{static BASE_PATH="/src/assets/SlapKirkApp";static getKirkSlapVideo(t){return`${this.BASE_PATH}/kirkslap/kirkslap${t}.webm`}static getKirkGruntSound(t){return`${this.BASE_PATH}/kirkgrunt/kirkgrunt${t}.webm`}static getSpockSlapFrames(){const t=[];for(let e=1;e<=25;e++)t.push(`${this.BASE_PATH}/spockslap/spockslap${e}.webp`);return t}static getRandomKirkSlapVideo(){const t=Math.floor(Math.random()*16)+1;return this.getKirkSlapVideo(t)}static getRandomKirkGruntSound(){const t=Math.floor(Math.random()*24)+1;return this.getKirkGruntSound(t)}static getAppLogo(){return`${this.BASE_PATH}/logo.svg`}}class B{audioElements=new Map;masterVolume=.7;enabled=!0;constructor(){this.preloadSounds()}async preloadSounds(){try{for(let t=1;t<=5;t++){const e=`/src/assets/SlapKirkApp/kirkgrunt/kirkgrunt${t}.webm`;await this.loadSound(`kirkgrunt${t}`,e,{preload:!0})}console.log("声音预加载完成")}catch(t){console.warn("声音预加载失败:",t)}}async loadSound(t,e,s={}){if(this.audioElements.has(t))return this.audioElements.get(t);const i=new Audio;return i.src=e,i.volume=(s.volume||1)*this.masterVolume,i.loop=s.loop||!1,s.preload&&(i.preload="auto"),new Promise((n,o)=>{i.addEventListener("canplaythrough",()=>{this.audioElements.set(t,i),n(i)}),i.addEventListener("error",c=>{console.warn(`音频加载失败: ${e}`,c),o(c)}),i.load()})}async playSound(t,e,s={}){if(this.enabled)try{let i;if(this.audioElements.has(t))i=this.audioElements.get(t);else if(e)i=await this.loadSound(t,e,s);else{console.warn(`声音 ${t} 未找到且未提供路径`);return}i.currentTime=0,i.volume=(s.volume||1)*this.masterVolume,await i.play()}catch(i){console.warn(`播放声音失败: ${t}`,i)}}async playRandomKirkGrunt(){const t=Math.floor(Math.random()*24)+1,e=`kirkgrunt${t}`,s=`/src/assets/SlapKirkApp/kirkgrunt/kirkgrunt${t}.webm`;await this.playSound(e,s,{volume:.8})}stopSound(t){const e=this.audioElements.get(t);e&&(e.pause(),e.currentTime=0)}stopAllSounds(){this.audioElements.forEach(t=>{t.pause(),t.currentTime=0})}setMasterVolume(t){this.masterVolume=Math.max(0,Math.min(1,t)),this.audioElements.forEach(e=>{e.volume=e.volume*this.masterVolume})}getMasterVolume(){return this.masterVolume}setEnabled(t){this.enabled=t,t||this.stopAllSounds()}isEnabled(){return this.enabled}destroy(){this.stopAllSounds(),this.audioElements.clear()}}const W=new B,Y="_gameContainer_1qj8s_1",K="_header_1qj8s_34",z="_title_1qj8s_44",U="_headerControls_1qj8s_50",J="_controlButton_1qj8s_54",X="_gameArea_1qj8s_73",Z="_leftPanel_1qj8s_81",Q="_rightPanel_1qj8s_88",tt="_animationView_1qj8s_97",et="_debugLabel_1qj8s_122",st="_gestureIndicator_1qj8s_168",it="_gestureEmoji_1qj8s_177",at="_gestureText_1qj8s_182",nt="_confidenceBar_1qj8s_188",ot="_confidenceFill_1qj8s_196",lt="_kirkAvatar_1qj8s_202",rt="_slapped_1qj8s_211",ct="_kirkFace_1qj8s_214",ht="_kirkContainer_1qj8s_219",dt="_kirkDefault_1qj8s_234",ut="_slapEffect_1qj8s_237",mt="_spockDefault_1qj8s_243",ft="_gameStatus_1qj8s_315",gt="_loadingText_1qj8s_318",pt="_startButton_1qj8s_323",xt="_pausedText_1qj8s_342",yt="_manualSlapButton_1qj8s_356",St="_statsPanel_1qj8s_370",vt="_statItem_1qj8s_378",bt="_statLabel_1qj8s_381",kt="_statValue_1qj8s_387",wt="_combo_1qj8s_393",r={gameContainer:Y,header:K,title:z,headerControls:U,controlButton:J,gameArea:X,leftPanel:Z,rightPanel:Q,animationView:tt,debugLabel:et,gestureIndicator:st,gestureEmoji:it,gestureText:at,confidenceBar:nt,confidenceFill:ot,kirkAvatar:lt,slapped:rt,kirkFace:ct,kirkContainer:ht,kirkDefault:dt,slapEffect:ut,spockDefault:mt,gameStatus:ft,loadingText:gt,startButton:pt,pausedText:xt,manualSlapButton:yt,statsPanel:St,statItem:vt,statLabel:bt,statValue:kt,combo:wt},Ft=({isBeingSlapped:a,slapIntensity:t})=>{const e=m.useRef(null),s=m.useRef(new _),[i,n]=m.useState(!1);return m.useEffect(()=>{if(a&&!i&&e.current){n(!0);const o=j.getRandomKirkSlapVideo();s.current.playVideoAnimation(e.current,{type:"video",videoPath:o,loop:!1,autoplay:!0},()=>{n(!1),e.current&&(e.current.innerHTML=`
              <div class="${r.kirkFace}">
                <div class="${r.kirkDefault}">🖖</div>
              </div>
            `)}),W.playRandomKirkGrunt()}},[a,t,i]),m.useEffect(()=>()=>{s.current.destroy()},[]),l.jsxs("div",{className:`${r.kirkAvatar} ${a?r.slapped:""}`,children:[l.jsx("div",{ref:e,className:r.kirkContainer,children:!i&&l.jsx("div",{className:r.kirkFace,children:l.jsx("div",{className:r.kirkDefault,children:"🖖"})})}),a&&l.jsx("div",{className:r.slapEffect,children:"💥"})]})},At=({stats:a,gameLogic:t})=>l.jsxs("div",{className:r.statsPanel,children:[l.jsxs("div",{className:r.statItem,children:[l.jsx("span",{className:r.statLabel,children:"扇击次数"}),l.jsx("span",{className:r.statValue,children:a.totalSlaps})]}),l.jsxs("div",{className:r.statItem,children:[l.jsx("span",{className:r.statLabel,children:"连击"}),l.jsxs("span",{className:`${r.statValue} ${a.currentCombo>0?r.combo:""}`,children:[a.currentCombo>0&&"🔥"," ",a.currentCombo]})]}),l.jsxs("div",{className:r.statItem,children:[l.jsx("span",{className:r.statLabel,children:"最高连击"}),l.jsx("span",{className:r.statValue,children:a.maxCombo})]}),l.jsxs("div",{className:r.statItem,children:[l.jsx("span",{className:r.statLabel,children:"游戏时长"}),l.jsx("span",{className:r.statValue,children:t.formatTime(a.sessionTime)})]})]}),Tt=({currentGesture:a,confidence:t,isAIReady:e})=>{const i=(()=>{if(!e)return{emoji:"🤖",text:"AI加载中...",color:"#666"};switch(a){case w.READY:return{emoji:"✋",text:"准备中",color:"#4CAF50"};case w.SLAP:return{emoji:"👋",text:"扇击!",color:"#FF5722"};case w.FIST:return{emoji:"✊",text:"拳头",color:"#FF9800"};case w.PEACE:return{emoji:"✌️",text:"特殊技能",color:"#9C27B0"};default:return{emoji:"👁️",text:"等待手势...",color:"#2196F3"}}})();return l.jsxs("div",{className:r.gestureIndicator,children:[l.jsx("div",{className:r.gestureEmoji,children:i.emoji}),l.jsx("div",{className:r.gestureText,style:{color:i.color},children:i.text}),e&&l.jsx("div",{className:r.confidenceBar,children:l.jsx("div",{className:r.confidenceFill,style:{width:`${t*100}%`,backgroundColor:i.color}})})]})},Et=({debugCanvas:a,debugMode:t,gestureEngine:e,showSpockSlap:s,onSpockSlapComplete:i})=>{const n=m.useRef(null),o=m.useRef(new _);m.useEffect(()=>{if(s&&n.current){const h=j.getSpockSlapFrames();o.current.playFrameAnimation(n.current,{type:"frames",framePaths:h,frameRate:24,loop:!0},i)}else!s&&n.current&&(o.current.stop(),n.current.innerHTML=`
        <div class="${r.spockDefault}">
          <img src="/src/assets/SlapKirkApp/spockslap/spockslap1.webp" alt="Spock" />
        </div>
      `)},[s,i]),m.useEffect(()=>{n.current&&a&&(n.current.querySelector("canvas")||n.current.appendChild(a),a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.width="100%",a.style.height="100%",a.style.zIndex="10",a.style.pointerEvents="none",a.style.backgroundColor="transparent",a.style.borderRadius="12px")},[a]),m.useEffect(()=>()=>{o.current.destroy()},[]);const c=m.useCallback(()=>{t&&(e.getAdvancedDebugMode()?(e.disableAdvancedDebug(),console.log("关闭高级调试模式")):(e.enableAdvancedDebug(),console.log("开启高级调试模式 - 显示手部关键点")))},[t,e]);return l.jsxs("div",{className:r.animationView,onDoubleClick:c,children:[l.jsx("div",{ref:n,style:{width:"100%",height:"100%",position:"relative"}}),t&&l.jsx("div",{className:r.debugLabel,children:"🔍 调试模式 - 显示手部关键点"})]})},Dt=()=>{const[a]=m.useState(()=>new O),[t]=m.useState(()=>new V),[e,s]=m.useState(S.LOADING),[i,n]=m.useState(a.getStats()),[o,c]=m.useState(w.NONE),[h,f]=m.useState(0),[g,d]=m.useState(!1),[u,p]=m.useState(0),[x,y]=m.useState(!1),[v,b]=m.useState(!1);m.useEffect(()=>((async()=>{console.log("开始初始化AI手势识别...");try{await t.initialize()?(s(S.READY),t.onGestureDetected=E=>{c(E.type),f(E.confidence),a.handleGesture(E)},await t.startDetection()):(console.error("AI引擎初始化失败"),s(S.READY))}catch(k){console.error("初始化错误:",k),s(S.READY)}})(),a.onStatsUpdate=k=>{n({...k})},a.onSlapEffect=k=>{y(!0),setTimeout(()=>{d(!0),p(k),setTimeout(()=>d(!1),100)},300)},a.onGameStateChange=k=>{s(k)},()=>{t.dispose()}),[a,t]);const T=m.useCallback(()=>{a.startSession()},[a]),P=m.useCallback(()=>{e===S.PLAYING?a.pauseGame():e===S.PAUSED&&a.resumeGame()},[e,a]),C=m.useCallback(()=>{a.resetAllData()},[a]),I=m.useCallback(()=>{const A=!v;console.log(`准备${A?"开启":"关闭"}调试模式...`),b(A),setTimeout(()=>{try{t.setDebugMode(A),console.log(`调试模式已${A?"开启":"关闭"}`)}catch(k){console.error("切换调试模式失败:",k),b(!A)}},50)},[v,t]),N=m.useCallback(()=>{const A={type:w.SLAP,confidence:1,velocity:{x:.2,y:.1,magnitude:.22}};a.handleGesture(A)},[a]);return l.jsxs("div",{className:r.gameContainer,children:[l.jsxs("div",{className:r.header,children:[l.jsx("div",{className:r.title,children:"🖖 AI Slap Kirk"}),l.jsxs("div",{className:r.headerControls,children:[l.jsx("button",{className:r.controlButton,onClick:I,title:v?"关闭调试模式":"开启调试模式",children:v?"🔍":"👁️"}),l.jsx("button",{className:r.controlButton,onClick:P,disabled:e===S.LOADING,children:e===S.PLAYING?"⏸️":"▶️"}),l.jsx("button",{className:r.controlButton,onClick:C,title:"重置数据",children:"🔄"})]})]}),l.jsxs("div",{className:r.gameArea,children:[l.jsxs("div",{className:r.leftPanel,children:[l.jsx(Et,{debugCanvas:t.getDebugCanvas(),debugMode:v,gestureEngine:t,showSpockSlap:x,onSpockSlapComplete:()=>y(!1)}),l.jsx(Tt,{currentGesture:o,confidence:h,isAIReady:e!==S.LOADING})]}),l.jsxs("div",{className:r.rightPanel,children:[l.jsx(Ft,{isBeingSlapped:g,slapIntensity:u}),l.jsxs("div",{className:r.gameStatus,children:[e===S.LOADING&&l.jsx("div",{className:r.loadingText,children:"🤖 AI加载中..."}),e===S.READY&&l.jsx("button",{className:r.startButton,onClick:T,children:"🚀 开始游戏"}),e===S.PAUSED&&l.jsx("div",{className:r.pausedText,children:"⏸️ 游戏已暂停"})]}),e===S.PLAYING&&l.jsx("button",{className:r.manualSlapButton,onClick:N,title:"手动扇击（测试用）",children:"👋 手动扇击"})]})]}),l.jsx(At,{stats:i,gameLogic:a})]})};class M extends H{static icon=F.icon;static name=F.name;static id=F.id;root=null;launch(){this.openWindow()}openWindow(){const t=G.ins.showWindow("",{title:F.name,icon:F.icon,x:F.defaultWindow.x||200,y:F.defaultWindow.y||100,width:F.defaultWindow.width,height:F.defaultWindow.height});this.root=R.createRoot(t.content),this.root.render(L.createElement(Dt)),this.windows.set(t.id,t),t.on(q.EventType.ON_CLOSE,this.onClickClose)}onClickClose=()=>{$.ins.exitApp(M)};onExit(){this.root&&(this.root.unmount(),this.root=null)}}export{M as SlapKirkApp};
