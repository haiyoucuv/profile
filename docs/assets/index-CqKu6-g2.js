var B=Object.defineProperty;var H=(a,e,t)=>e in a?B(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var i=(a,e,t)=>H(a,typeof e!="symbol"?e+"":e,t);import{L as N,B as p,a as G,i as Y,b as W,D as O,g as V,C as j,N as k,M as w,V as y,c as D,d,S as U,R as L,G as Z,F as I,e as q,E as Q,f as _,O as K,h as J,j as S,k as R,l as $,m as ee,P as te,W as ie,n as se,o as ne,A as oe,p as ae,q as re,r as he,H as ce,s as de,t as le,u as me,v as ue,w as pe,x as we,y as M,z as f,I as ge,J as ve,K as u,Q as l,T as ye}from"./vendor-BItZLzkD.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=t(n);fetch(n.href,o)}})();const fe=""+new URL("my_stardew_valley_farm-qyeIgYac.glb",import.meta.url).href;function Se(a){return new Worker(""+new URL("navmesh-worker-BZEHHa0d.js",import.meta.url).href,{type:"module",name:a==null?void 0:a.name})}var m=(a=>(a[a.Default=0]="Default",a[a.DebugView=1]="DebugView",a))(m||{});class Re{constructor(e,t=!1){i(this,"navMesh");i(this,"crowd");i(this,"playerAgent");i(this,"pathLine");i(this,"debugDrawer");i(this,"scene");i(this,"debug",!1);this.pathLine=new N(new p,new G({color:255,linewidth:10})),e.add(this.pathLine),this.scene=e,this.debug=t}async init(e){await this.initNavMesh(e),this.initCrowd()}async initNavMesh(e){return console.time("init Recast"),await Y(),console.timeEnd("init Recast"),new Promise(t=>{const s={cs:.2,ch:.2,tileSize:64,walkableSlopeAngle:35,walkableHeight:1,walkableClimb:1,walkableRadius:1,maxEdgeLen:12,maxSimplificationError:1.3,minRegionArea:8,mergeRegionArea:20,maxVertsPerPoly:6,detailSampleDist:6,detailSampleMaxError:1},n=new Se;n.onmessage=r=>{console.timeEnd("Generate NavMesh");const g=r.data;this.navMesh=W(g).navMesh,this.debug&&(this.debugDrawer=new O,this.debugDrawer.layers.set(m.DebugView),this.scene.add(this.debugDrawer),this.debugDrawer.clear(),this.debugDrawer.drawNavMesh(this.navMesh),this.debugDrawer.children.forEach(v=>{v.layers.set(m.DebugView)})),t()};const o=[];e.traverse(r=>{r instanceof w&&o.push(r)});const[c,h]=V(o);console.time("Generate NavMesh"),n.postMessage({positions:c,indices:h,config:s},[c.buffer,h.buffer])})}initCrowd(){this.crowd=new j(this.navMesh,{maxAgents:10,maxAgentRadius:1})}getRandomPosition(e={x:0,y:0,z:0}){const s=new k(this.navMesh),{success:n,status:o,randomPolyRef:c,randomPoint:h}=s.findRandomPointAroundCircle(e,2);return h}addPlayer(e){this.playerAgent=this.crowd.addAgent(e,{radius:.5,height:1,maxSpeed:6,maxAcceleration:20,collisionQueryRange:.5,pathOptimizationRange:0,separationWeight:1})}movePlayerTo(e){var t;(t=this.playerAgent)==null||t.requestMoveTarget(e)}getPlayerPosition(){var e;return(e=this.playerAgent)==null?void 0:e.position()}update(e){var t;(t=this.crowd)==null||t.update(e),this.updatePath()}updatePath(){if(!this.playerAgent)return;this.pathLine.geometry.dispose(),this.pathLine.geometry=new p;const e=[this.playerAgent.position(),...this.playerAgent.corners()];this.pathLine.geometry.setFromPoints(e)}dispose(){var e,t;this.pathLine.geometry.dispose(),this.pathLine.material.dispose(),(e=this.navMesh)==null||e.destroy(),(t=this.debugDrawer)==null||t.dispose()}}class Pe{constructor(e,t,s,n={}){i(this,"camera");i(this,"target");i(this,"node");i(this,"currentPosition",new y);i(this,"currentLookAt",new y);i(this,"distance");i(this,"minDistance");i(this,"maxDistance");i(this,"rotationX");i(this,"rotationY");i(this,"minRotationX");i(this,"maxRotationX");i(this,"smoothSpeed");i(this,"minHeight");i(this,"rotationSpeed");i(this,"zoomSpeed");i(this,"touchRotationSensitivity");i(this,"touchZoomSensitivity");i(this,"enableCollision");i(this,"collisionLayers");i(this,"touchStart",new D);i(this,"prevTouchDistance",0);i(this,"isPointerDown",!1);i(this,"isTwoFingerTouch",!1);i(this,"onMouseWheel",e=>{e.preventDefault();const t=e.deltaY*.01;this.zoom(t)});i(this,"onTouchStart",e=>{e.touches.length===2&&(this.isTwoFingerTouch=!0,this.prevTouchDistance=this.getTouchDistance(e))});i(this,"onTouchMove",e=>{if(this.isTwoFingerTouch&&e.touches.length===2){const t=this.getTouchDistance(e),s=(this.prevTouchDistance-t)*this.touchZoomSensitivity;this.zoom(s),this.prevTouchDistance=t}});i(this,"onTouchEnd",()=>{this.isTwoFingerTouch=!1});i(this,"onPointerDown",e=>{this.isTwoFingerTouch||(this.isPointerDown=!0,this.touchStart.set(e.clientX,e.clientY))});i(this,"onPointerMove",e=>{if(!this.isPointerDown||this.isTwoFingerTouch)return;const t=e.clientX-this.touchStart.x,s=e.clientY-this.touchStart.y;this.rotate(t*this.touchRotationSensitivity,s*this.touchRotationSensitivity),this.touchStart.set(e.clientX,e.clientY)});i(this,"onPointerUp",()=>{this.isPointerDown=!1});this.camera=e,this.target=t,this.node=s;const{initialDistance:o=20,minDistance:c=5,maxDistance:h=30,initialRotationX:r=45,initialRotationY:g=45,minRotationX:v=-60,maxRotationX:E=60,smoothSpeed:b=.1,minHeight:x=.5,rotationSpeed:T=.5,zoomSpeed:C=1,touchRotationSensitivity:X=.5,touchZoomSensitivity:A=.2,enableCollision:z=!1,collisionLayers:F=[]}=n;this.distance=o,this.minDistance=c,this.maxDistance=h,this.rotationX=r,this.rotationY=g,this.minRotationX=v,this.maxRotationX=E,this.smoothSpeed=b,this.minHeight=x,this.rotationSpeed=T,this.zoomSpeed=C,this.touchRotationSensitivity=X,this.touchZoomSensitivity=A,this.enableCollision=z,this.collisionLayers=F,this.updateCameraPosition(),this.initControlEvent(s)}initControlEvent(e){e.addEventListener("pointerdown",this.onPointerDown),e.addEventListener("pointermove",this.onPointerMove),e.addEventListener("pointerup",this.onPointerUp),e.addEventListener("pointercancel",this.onPointerUp),e.addEventListener("touchstart",this.onTouchStart),e.addEventListener("touchmove",this.onTouchMove),e.addEventListener("touchend",this.onTouchEnd),e.addEventListener("touchcancel",this.onTouchEnd),e.addEventListener("wheel",this.onMouseWheel)}removeControlEvent(e){e.removeEventListener("pointerdown",this.onPointerDown),e.removeEventListener("pointermove",this.onPointerMove),e.removeEventListener("pointerup",this.onPointerUp),e.removeEventListener("pointercancel",this.onPointerUp),e.removeEventListener("touchstart",this.onTouchStart),e.removeEventListener("touchmove",this.onTouchMove),e.removeEventListener("touchend",this.onTouchEnd),e.removeEventListener("wheel",this.onMouseWheel)}getTouchDistance(e){const t=e.touches[0],s=e.touches[1];return Math.hypot(t.clientX-s.clientX,t.clientY-s.clientY)}rotate(e,t){this.rotationY-=e*this.rotationSpeed,this.rotationX+=t*this.rotationSpeed,this.rotationX=d.clamp(this.rotationX,this.minRotationX,this.maxRotationX)}zoom(e){this.distance=d.clamp(this.distance+e*this.zoomSpeed,this.minDistance,this.maxDistance)}updateCameraPosition(){var n;const e=new U(this.distance,d.degToRad(90-this.rotationX),d.degToRad(this.rotationY)),t=new y;t.setFromSpherical(e);const s=t.clone().normalize();if(this.enableCollision){const o=new L(this.target.position.clone(),s,this.camera.near,this.maxDistance);o.layers.set(m.Default),this.collisionLayers.length>0&&this.collisionLayers.forEach(h=>{o.layers.enable(h)}),o.layers.disable(m.DebugView);const c=o.intersectObjects(((n=this.target.parent)==null?void 0:n.children)||[],!0).filter(h=>h.distance>0);if(c.length>0){const h=c[0],r=Math.max(this.minDistance,h.distance-.5);t.copy(s).multiplyScalar(r)}}t.add(this.target.position),t.y<this.minHeight&&(t.y=this.minHeight),this.currentPosition.lerp(t,this.smoothSpeed),this.currentLookAt.lerp(this.target.position,this.smoothSpeed),this.camera.position.copy(this.currentPosition),this.camera.lookAt(this.currentLookAt)}setTarget(e){this.target=e}setDistance(e){this.distance=d.clamp(e,this.minDistance,this.maxDistance)}setRotation(e,t){this.rotationX=d.clamp(e,this.minRotationX,this.maxRotationX),this.rotationY=t}getConfig(){return{initialDistance:this.distance,minDistance:this.minDistance,maxDistance:this.maxDistance,minRotationX:this.minRotationX,maxRotationX:this.maxRotationX,initialRotationX:this.rotationX,initialRotationY:this.rotationY,minHeight:this.minHeight,smoothSpeed:this.smoothSpeed,rotationSpeed:this.rotationSpeed,zoomSpeed:this.zoomSpeed,touchRotationSensitivity:this.touchRotationSensitivity,touchZoomSensitivity:this.touchZoomSensitivity,enableCollision:this.enableCollision,collisionLayers:this.collisionLayers}}update(){this.updateCameraPosition()}dispose(){this.removeControlEvent(this.node)}}function P(a,e=16/9){return Math.atan(Math.tan(a*d.DEG2RAD*.5)/e)*d.RAD2DEG*2}const De=new Z;new I;class Le{constructor(e){i(this,"composer");i(this,"canvas");i(this,"renderer");i(this,"scene");i(this,"camera");i(this,"thirdCamera");i(this,"mapScene");i(this,"player");i(this,"navigationSystem");i(this,"clock",new q(!0));i(this,"outlineEffect");i(this,"onMouseDown",(()=>{const e=new L;e.firstHitOnly=!0;const t=new D;return s=>{if(s.button!==2)return;const{clientX:n,clientY:o}=s,c=this.canvas.getBoundingClientRect();t.x=(n-c.left)/this.canvas.offsetWidth*2-1,t.y=-((o-c.top)/this.canvas.offsetHeight)*2+1,e.setFromCamera(t,this.camera),console.time("raycast");const h=e.intersectObject(this.mapScene);if(console.timeEnd("raycast"),h.length>0){const r=h[0].point;this.navigationSystem.movePlayerTo(r)}}})());i(this,"onResize",()=>{this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.camera.aspect=window.innerWidth/window.innerHeight;const e=P(90,Math.max(this.camera.aspect,16/9));this.camera.fov=e,this.camera.updateProjectionMatrix(),this.composer.setSize(window.innerWidth,window.innerHeight)});i(this,"onUpdate",()=>{var t,s;const e=this.clock.getDelta();this.composer.render(),(t=this.navigationSystem)==null||t.update(e),(s=this.navigationSystem)!=null&&s.getPlayerPosition()&&this.player.position.copy(this.navigationSystem.getPlayerPosition()),this.thirdCamera.update()});this.canvas=e}async start(){this.initScene(),this.initPostProcessing(),await this.addMap(),this.outlineEffect.selection.add(this.player),this.navigationSystem=new Re(this.scene),await this.navigationSystem.init(this.mapScene);const e=this.navigationSystem.getRandomPosition();this.navigationSystem.addPlayer(e),this.renderer.setAnimationLoop(this.onUpdate),this.onResize(),window.addEventListener("resize",this.onResize),this.canvas.addEventListener("mousedown",this.onMouseDown)}initPostProcessing(){const{scene:e,camera:t,renderer:s}=this,n=this.composer=new Q(s);n.addPass(new _(e,t)),K.workaroundEnabled=!0;const o=this.outlineEffect=new J(e,t,{blendFunction:S.SCREEN,edgeStrength:8,visibleEdgeColor:0,hiddenEdgeColor:16711935,xRay:!0});n.addPass(new R(t,o)),n.addPass(new R(t,new $({blendFunction:S.NORMAL})))}initScene(){this.scene=new ee;const e=window.innerWidth/window.innerHeight,t=P(90,Math.max(e,16/9));this.camera=new te(t,window.innerWidth/window.innerHeight,.1,1e3);const s=this.renderer=new ie({canvas:this.canvas,powerPreference:"high-performance",antialias:!1,stencil:!1,depth:!1});s.setClearColor(16777215),s.shadowMap.enabled=!0,s.shadowMap.type=se,s.outputColorSpace=ne,s.toneMapping=oe,s.toneMappingExposure=1;const o=new ae(this.renderer).fromScene(re()).texture;this.scene.environment=o;const c=new he(4210752,.1);this.scene.add(c);const h=new ce(16777215,4473924,1);h.position.set(0,1,0),this.scene.add(h);const r=new de(16777215,3);r.shadow.intensity=2,r.shadow.camera.top=50,r.shadow.camera.bottom=-50,r.shadow.camera.left=-50,r.shadow.camera.right=50,r.shadow.bias=-1e-4,r.shadow.mapSize.set(4096,4096),r.shadow.radius=100,r.position.set(50,100,50),r.castShadow=!0,this.scene.add(r),this.scene.add(new le(r.shadow.camera)),this.player=new w(new me(1,1,1),new ue),this.player.castShadow=!0,this.player.receiveShadow=!0,this.scene.add(this.player),this.thirdCamera=new Pe(this.camera,this.player,this.canvas)}async addMap(){const e=await De.loadAsync(fe);this.mapScene=e.scene,this.mapScene.scale.set(5,5,5),this.scene.add(e.scene),e.scene.traverse(t=>{t instanceof w&&(t.castShadow=!0,t.receiveShadow=!0)})}destroy(){var e;window.removeEventListener("resize",this.onResize),this.canvas.removeEventListener("mousedown",this.onMouseDown),this.renderer.dispose(),(e=this.navigationSystem)==null||e.dispose()}}p.prototype.computeBoundsTree=pe;p.prototype.disposeBoundsTree=we;w.prototype.raycast=M;f.prototype.computeBoundsTree=ge;f.prototype.disposeBoundsTree=ve;f.prototype.raycast=M;function Me(){const[a,e]=u.useState(!0),t=u.useRef(null),s=u.useRef(null);return u.useEffect(()=>((async()=>{s.current=new Le(t.current),await s.current.start(),e(!1)})(),()=>{var o;(o=s.current)==null||o.destroy()}),[]),l.jsxs("div",{className:"app",children:[l.jsx("canvas",{className:"gameCanvas",onContextMenu:n=>n.preventDefault(),ref:t}),a&&l.jsxs("div",{className:"loading",children:[l.jsx("div",{className:"loading-spinner"}),l.jsx("div",{className:"loading-text",children:"Loading..."})]})]})}ye(document.getElementById("root")).render(l.jsx(Me,{}));
