import{r as d,_ as R,j as s,f as w,b as Z,R as H,A as J}from"./index-B-KT0xZn.js";import{V as Q,W as ee,a as te}from"./VirtualApp-C1dA06xo.js";const re="_container_13wuy_1",ne="_leftPanel_13wuy_8",se="_centerPanel_13wuy_16",ae="_rightPanel_13wuy_23",ie="_panelHeader_13wuy_31",oe="_panelTitle_13wuy_39",le="_panelContent_13wuy_47",ce="_panelFooter_13wuy_52",ue="_toolbar_13wuy_57",de="_toolbarLeft_13wuy_67",he="_resetButton_13wuy_72",ge="_viewControls_13wuy_78",me="_toolbarButton_13wuy_83",pe="_zoomInfo_13wuy_102",fe="_canvasContainer_13wuy_108",xe="_canvas_13wuy_108",ve="_dropZone_13wuy_128",be="_dropZoneIcon_13wuy_161",_e="_dropZoneText_13wuy_166",ye="_dropZoneSubtext_13wuy_171",we="_controlSection_13wuy_175",Te="_controlGroup_13wuy_190",Le="_controlLabel_13wuy_196",Ee="_slider_13wuy_202",Ce="_sliderValue_13wuy_230",Pe="_button_13wuy_238",Ue="_buttonSecondary_13wuy_257",Re="_fileInput_13wuy_264",Ne="_statusBar_13wuy_292",Ie="_helpText_13wuy_302",ze="_renderBackend_13wuy_307",je="_loadingOverlay_13wuy_312",Ae="_spinner_13wuy_324",Se="_errorMessage_13wuy_340",o={container:re,leftPanel:ne,centerPanel:se,rightPanel:ae,panelHeader:ie,panelTitle:oe,panelContent:le,panelFooter:ce,toolbar:ue,toolbarLeft:de,resetButton:he,viewControls:ge,toolbarButton:me,zoomInfo:pe,canvasContainer:fe,canvas:xe,dropZone:ve,dropZoneIcon:be,dropZoneText:_e,dropZoneSubtext:ye,controlSection:we,controlGroup:Te,controlLabel:Le,slider:Ee,sliderValue:Ce,button:Pe,buttonSecondary:Ue,fileInput:Re,statusBar:Ne,helpText:Ie,renderBackend:ze,loadingOverlay:je,spinner:Ae,errorMessage:Se},Be=`struct VertexOutput {\r
    @builtin(position) position: vec4<f32>,\r
    @location(0) texCoord: vec2<f32>,\r
}\r
\r
struct Uniforms {\r
    intensity: f32,\r
    brightness: f32,\r
    contrast: f32,\r
    saturation: f32,\r
    hue: f32,\r
}\r
\r
@group(0) @binding(0) var<uniform> uniforms: Uniforms;\r
@group(0) @binding(1) var imageSampler: sampler;\r
@group(0) @binding(2) var imageTexture: texture_2d<f32>;\r
@group(0) @binding(3) var lutSampler: sampler;\r
@group(0) @binding(4) var lutTexture: texture_3d<f32>;\r
\r
@vertex\r
fn vs_main(@builtin(vertex_index) vertexIndex: u32) -> VertexOutput {\r
    var pos = array<vec2<f32>, 6>(\r
        vec2<f32>(-1.0, -1.0),\r
        vec2<f32>(1.0, -1.0),\r
        vec2<f32>(-1.0, 1.0),\r
        vec2<f32>(1.0, -1.0),\r
        vec2<f32>(1.0, 1.0),\r
        vec2<f32>(-1.0, 1.0)\r
    );\r
\r
    var texCoord = array<vec2<f32>, 6>(\r
        vec2<f32>(0.0, 1.0),\r
        vec2<f32>(1.0, 1.0),\r
        vec2<f32>(0.0, 0.0),\r
        vec2<f32>(1.0, 1.0),\r
        vec2<f32>(1.0, 0.0),\r
        vec2<f32>(0.0, 0.0)\r
    );\r
\r
    var output: VertexOutput;\r
    output.position = vec4<f32>(pos[vertexIndex], 0.0, 1.0);\r
    output.texCoord = texCoord[vertexIndex];\r
    return output;\r
}\r
\r
fn rgb2hsv(c: vec3<f32>) -> vec3<f32> {\r
    let K = vec4<f32>(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\r
    let p = mix(vec4<f32>(c.bg, K.wz), vec4<f32>(c.gb, K.xy), step(c.b, c.g));\r
    let q = mix(vec4<f32>(p.xyw, c.r), vec4<f32>(c.r, p.yzx), step(p.x, c.r));\r
    let d = q.x - min(q.w, q.y);\r
    let e = 1.0e-10;\r
    return vec3<f32>(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\r
}\r
\r
fn hsv2rgb(c: vec3<f32>) -> vec3<f32> {\r
    let K = vec4<f32>(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\r
    let p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\r
    return c.z * mix(K.xxx, clamp(p - K.xxx, vec3<f32>(0.0), vec3<f32>(1.0)), c.y);\r
}\r
\r
@fragment\r
fn fs_main(input: VertexOutput) -> @location(0) vec4<f32> {\r
    var color = textureSample(imageTexture, imageSampler, input.texCoord);\r
\r
          // 应用基础调整\r
    var adjustedRgb = (color.rgb - vec3<f32>(0.5)) * uniforms.contrast + vec3<f32>(0.5) + vec3<f32>(uniforms.brightness);\r
    color = vec4<f32>(adjustedRgb, color.a);\r
\r
          // 色相和饱和度调整\r
    var hsv = rgb2hsv(color.rgb);\r
    hsv.x = fract(hsv.x + uniforms.hue);\r
    hsv.y = hsv.y * uniforms.saturation;\r
    var hsvRgb = hsv2rgb(hsv);\r
    color = vec4<f32>(hsvRgb, color.a);\r
\r
          // 应用LUT\r
    let lutCoord = clamp(color.rgb, vec3<f32>(0.0), vec3<f32>(1.0));\r
    let lutColor = textureSample(lutTexture, lutSampler, lutCoord);\r
\r
          // 混合原色和LUT颜色\r
    let finalRgb = mix(color.rgb, lutColor.rgb, uniforms.intensity);\r
\r
    return vec4<f32>(finalRgb, color.a);\r
}\r
`,ke=`#version 300 es\r
in vec2 a_position;\r
in vec2 a_texCoord;\r
out vec2 v_texCoord;\r
\r
void main() {\r
    gl_Position = vec4(a_position, 0.0, 1.0);\r
    v_texCoord = a_texCoord;\r
}\r
\r
`,Fe=`#version 300 es\r
precision highp float;\r
\r
uniform sampler2D u_image;\r
uniform sampler3D u_lut;\r
uniform float u_intensity;\r
uniform float u_brightness;\r
uniform float u_contrast;\r
uniform float u_saturation;\r
uniform float u_hue;\r
\r
in vec2 v_texCoord;\r
out vec4 fragColor;\r
\r
vec3 rgb2hsv(vec3 c) {\r
    vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\r
    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\r
    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\r
    float d = q.x - min(q.w, q.y);\r
    float e = 1.0e-10;\r
    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\r
}\r
\r
vec3 hsv2rgb(vec3 c) {\r
    vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\r
    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\r
    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\r
}\r
\r
void main() {\r
    vec4 color = texture(u_image, v_texCoord);\r
\r
    // 基础调整\r
    color.rgb = (color.rgb - 0.5) * u_contrast + 0.5 + u_brightness;\r
\r
    // 色相饱和度调整\r
    vec3 hsv = rgb2hsv(color.rgb);\r
    hsv.x = fract(hsv.x + u_hue);\r
    hsv.y *= u_saturation;\r
    color.rgb = hsv2rgb(hsv);\r
\r
    // 应用LUT\r
    vec3 lutCoord = clamp(color.rgb, 0.0, 1.0);\r
    vec3 lutColor = texture(u_lut, lutCoord).rgb;\r
\r
    // 混合\r
    color.rgb = mix(color.rgb, lutColor, u_intensity);\r
\r
    fragColor = vec4(color.rgb, color.a);\r
}\r
\r
`;class G{canvas;backend;constructor(e,n){this.canvas=e,this.backend=n}}class Me extends G{device=null;context=null;pipeline=null;imageTexture=null;lutTexture=null;uniformBuffer=null;bindGroup=null;constructor(e){super(e,"webgpu")}async initialize(){try{if(!navigator.gpu)return console.warn("WebGPU not supported"),!1;const e=await navigator.gpu.requestAdapter();if(!e)return console.warn("WebGPU adapter not available"),!1;if(this.device=await e.requestDevice(),this.context=this.canvas.getContext("webgpu"),!this.context)return console.warn("WebGPU context not available"),!1;const n=navigator.gpu.getPreferredCanvasFormat();return this.context.configure({device:this.device,format:n,alphaMode:"premultiplied"}),await this.createPipeline(),console.log("WebGPU initialized successfully"),!0}catch(e){return console.error("WebGPU initialization failed:",e),!1}}async createPipeline(){if(!this.device)return;const e=this.device.createShaderModule({code:Be});this.pipeline=this.device.createRenderPipeline({layout:"auto",vertex:{module:e,entryPoint:"vs_main"},fragment:{module:e,entryPoint:"fs_main",targets:[{format:navigator.gpu.getPreferredCanvasFormat()}]},primitive:{topology:"triangle-list"}}),this.uniformBuffer=this.device.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST})}createBindGroup(){if(!this.device||!this.pipeline||!this.imageTexture||!this.lutTexture||!this.uniformBuffer){console.log("Cannot create bind group - missing resources");return}console.log("Creating WebGPU bind group with 3D LUT texture"),this.bindGroup=this.device.createBindGroup({layout:this.pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.uniformBuffer}},{binding:1,resource:this.device.createSampler({magFilter:"linear",minFilter:"linear"})},{binding:2,resource:this.imageTexture.createView()},{binding:3,resource:this.device.createSampler({magFilter:"linear",minFilter:"linear"})},{binding:4,resource:this.lutTexture.createView({dimension:"3d"})}]}),console.log("WebGPU bind group created successfully")}async loadTexture(e){if(!this.device||!this.context)return;this.canvas.width=e.width,this.canvas.height=e.height;const n=navigator.gpu.getPreferredCanvasFormat();this.context.configure({device:this.device,format:n,alphaMode:"premultiplied"}),this.imageTexture=this.device.createTexture({size:[e.width,e.height,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST}),this.device.queue.writeTexture({texture:this.imageTexture},e.data,{bytesPerRow:e.width*4},{width:e.width,height:e.height}),this.lutTexture&&this.uniformBuffer&&this.pipeline&&this.createBindGroup()}async loadLUT(e){if(!this.device)return;this.lutTexture=this.device.createTexture({size:[e.size,e.size,e.size],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST,dimension:"3d"}),console.log(`Created 3D LUT texture: ${e.size}x${e.size}x${e.size}`);const n=new Uint8Array(e.data.length);for(let r=0;r<e.data.length;r++)n[r]=Math.round(Math.max(0,Math.min(1,e.data[r]))*255);this.device.queue.writeTexture({texture:this.lutTexture},n,{bytesPerRow:e.size*4,rowsPerImage:e.size},{width:e.size,height:e.size,depthOrArrayLayers:e.size}),this.imageTexture&&this.uniformBuffer&&this.pipeline&&this.createBindGroup()}async render(e){if(!this.device||!this.context||!this.pipeline||!this.bindGroup||!this.uniformBuffer)return;const n=new Float32Array(8);n[0]=e.intensity,n[1]=e.brightness,n[2]=e.contrast,n[3]=e.saturation,n[4]=e.hue,this.device.queue.writeBuffer(this.uniformBuffer,0,n);const r=this.device.createCommandEncoder(),t=r.beginRenderPass({colorAttachments:[{view:this.context.getCurrentTexture().createView(),clearValue:{r:0,g:0,b:0,a:1},loadOp:"clear",storeOp:"store"}]});t.setPipeline(this.pipeline),t.setBindGroup(0,this.bindGroup),t.draw(6),t.end(),this.device.queue.submit([r.finish()])}async exportImage(){return this.device&&await this.device.queue.onSubmittedWorkDone(),new Promise((e,n)=>{try{this.canvas.toBlob(r=>{r?e(r):n(new Error("Failed to create blob from canvas"))},"image/png",1)}catch(r){n(r)}})}dispose(){this.imageTexture?.destroy(),this.lutTexture?.destroy(),this.uniformBuffer?.destroy(),this.device=null,this.context=null}}class Ge extends G{gl=null;program=null;imageTexture=null;lutTexture=null;framebuffer=null;constructor(e){super(e,"webgl")}async initialize(){try{return this.gl=this.canvas.getContext("webgl2"),this.gl?(await this.createShaderProgram(),this.setupGeometry(),console.log("WebGL initialized successfully"),!0):(console.warn("WebGL2 not supported"),!1)}catch(e){return console.error("WebGL initialization failed:",e),!1}}async createShaderProgram(){if(!this.gl)return;const e=this.createShader(this.gl.VERTEX_SHADER,ke),n=this.createShader(this.gl.FRAGMENT_SHADER,Fe);if(this.program=this.gl.createProgram(),this.gl.attachShader(this.program,e),this.gl.attachShader(this.program,n),this.gl.linkProgram(this.program),!this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS))throw new Error("Shader program linking failed: "+this.gl.getProgramInfoLog(this.program))}createShader(e,n){if(!this.gl)throw new Error("WebGL context not initialized");const r=this.gl.createShader(e);if(this.gl.shaderSource(r,n),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS))throw new Error("Shader compilation failed: "+this.gl.getShaderInfoLog(r));return r}setupGeometry(){if(!this.gl||!this.program)return;const e=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,-1,1,1,1,1,1,0,-1,1,0,0]),n=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,n),this.gl.bufferData(this.gl.ARRAY_BUFFER,e,this.gl.STATIC_DRAW);const r=this.gl.getAttribLocation(this.program,"a_position"),t=this.gl.getAttribLocation(this.program,"a_texCoord");this.gl.enableVertexAttribArray(r),this.gl.vertexAttribPointer(r,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(t),this.gl.vertexAttribPointer(t,2,this.gl.FLOAT,!1,16,8)}async loadTexture(e){this.gl&&(this.canvas.width=e.width,this.canvas.height=e.height,this.imageTexture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_2D,this.imageTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,e.width,e.height,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e.data),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE))}async loadLUT(e){if(!this.gl)return;this.lutTexture=this.gl.createTexture(),this.gl.bindTexture(this.gl.TEXTURE_3D,this.lutTexture);const n=new Uint8Array(e.data.length);for(let r=0;r<e.data.length;r++)n[r]=Math.round(Math.max(0,Math.min(1,e.data[r]))*255);this.gl.texImage3D(this.gl.TEXTURE_3D,0,this.gl.RGBA,e.size,e.size,e.size,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,n),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_3D,this.gl.TEXTURE_WRAP_R,this.gl.CLAMP_TO_EDGE)}async render(e){!this.gl||!this.program||!this.imageTexture||!this.lutTexture||(this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.useProgram(this.program),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.imageTexture),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_image"),0),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_3D,this.lutTexture),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_lut"),1),this.gl.uniform1f(this.gl.getUniformLocation(this.program,"u_intensity"),e.intensity),this.gl.uniform1f(this.gl.getUniformLocation(this.program,"u_brightness"),e.brightness),this.gl.uniform1f(this.gl.getUniformLocation(this.program,"u_contrast"),e.contrast),this.gl.uniform1f(this.gl.getUniformLocation(this.program,"u_saturation"),e.saturation),this.gl.uniform1f(this.gl.getUniformLocation(this.program,"u_hue"),e.hue),this.gl.drawArrays(this.gl.TRIANGLES,0,6))}async exportImage(){return this.gl&&this.gl.finish(),new Promise((e,n)=>{try{this.canvas.toBlob(r=>{r?e(r):n(new Error("Failed to create blob from canvas"))},"image/png",1)}catch(r){n(r)}})}dispose(){this.gl&&(this.gl.deleteTexture(this.imageTexture),this.gl.deleteTexture(this.lutTexture),this.gl.deleteProgram(this.program),this.gl.deleteFramebuffer(this.framebuffer)),this.gl=null}}class Oe{static async create(e){const n=new Me(e);if(await n.initialize())return n;console.log("Falling back to WebGL");const r=new Ge(e);if(await r.initialize())return r;throw new Error("Neither WebGPU nor WebGL2 is supported")}}class C{static async parseCubeLUT(e){const r=(await e.text()).split(`
`).map(u=>u.trim()).filter(u=>u&&!u.startsWith("#"));let t=0;const l=[];for(const u of r)if(u.startsWith("TITLE"))u.substring(5).trim().replace(/"/g,"");else if(u.startsWith("LUT_3D_SIZE"))t=parseInt(u.split(" ")[1]);else if(u.startsWith("DOMAIN_MIN"))u.split(" ").slice(1).map(Number);else if(u.startsWith("DOMAIN_MAX"))u.split(" ").slice(1).map(Number);else{const g=u.split(/\s+/).map(Number);g.length===3&&g.every(h=>!isNaN(h))&&l.push(g[0],g[1],g[2],1)}if(t===0)throw new Error("Invalid LUT file: LUT_3D_SIZE not found");if(l.length!==t*t*t*4)throw new Error(`Invalid LUT file: Expected ${t*t*t*4} values, got ${l.length}`);return{size:t,data:new Float32Array(l)}}static async parse3dlLUT(e){const r=(await e.text()).split(`
`).map(g=>g.trim()).filter(g=>g&&!g.startsWith("#")),t=[];let l=0;for(const g of r){const h=g.split(/\s+/).map(Number);h.length===3&&h.every(f=>!isNaN(f))&&t.push(h[0],h[1],h[2],1)}const u=t.length/4;if(l=Math.round(Math.cbrt(u)),l*l*l*4!==t.length)throw new Error("Invalid 3DL LUT file: Data size does not match cubic dimensions");return{size:l,data:new Float32Array(t)}}static createIdentityLUT(e=32){const n=new Float32Array(e*e*e*4);let r=0;for(let t=0;t<e;t++)for(let l=0;l<e;l++)for(let u=0;u<e;u++)n[r++]=u/(e-1),n[r++]=l/(e-1),n[r++]=t/(e-1),n[r++]=1;return{size:e,data:n}}static createPresetLUT(e,n=32){const r=new Float32Array(n*n*n*4);let t=0;for(let l=0;l<n;l++)for(let u=0;u<n;u++)for(let g=0;g<n;g++){let h=g/(n-1),f=u/(n-1),m=l/(n-1);switch(e){case"warm":h=Math.min(1,h*1.1+.05),f=Math.min(1,f*1.05),m=Math.max(0,m*.9);break;case"cool":h=Math.max(0,h*.9),f=Math.min(1,f*1.05),m=Math.min(1,m*1.1+.05);break;case"vintage":h=Math.min(1,h*1.2+.1),f=Math.min(1,f*1.1+.05),m=Math.max(0,m*.8);const _=h*.393+f*.769+m*.189;h=Math.min(1,_),f=Math.min(1,_*.9),m=Math.min(1,_*.7);break;case"dramatic":h=h<.5?h*.8:Math.min(1,h*1.3),f=f<.5?f*.8:Math.min(1,f*1.3),m=m<.5?m*.8:Math.min(1,m*1.3);break;case"monochrome":h=f=m=h*.299+f*.587+m*.114;break}r[t++]=h,r[t++]=f,r[t++]=m,r[t++]=1}return{size:n,data:r}}static async parseLUT(e){const n=e.name.toLowerCase().split(".").pop();switch(n){case"cube":return this.parseCubeLUT(e);case"3dl":return this.parse3dlLUT(e);default:throw new Error(`Unsupported LUT format: ${n}`)}}}function We(p,e=!0){d.useEffect(()=>{if(!e)return;const n=r=>{const t=[];r.ctrlKey&&t.push("ctrl"),r.metaKey&&t.push("cmd"),r.shiftKey&&t.push("shift"),r.altKey&&t.push("alt");const l=r.key.toLowerCase(),u=[...t,l].join("+"),g=p[u];g&&(r.preventDefault(),r.stopPropagation(),g())};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[p,e])}const N={zoomIn:["ctrl+=","cmd+=","ctrl+plus"],zoomOut:["ctrl+-","cmd+-","ctrl+minus"],zoomReset:["ctrl+0","cmd+0"],zoomFit:["ctrl+1","cmd+1"],export:["ctrl+e","cmd+e"]};function De(p,e){const n={};return Object.entries(p).forEach(([r,t])=>{const l=e[r];l&&t.forEach(u=>{n[u]=l})}),n}class T{static _instance;lutCache=new Map;advancedPresets=[];isInitialized=!1;static get instance(){return T._instance||(T._instance=new T),T._instance}getBasicPresets(){return[{id:"identity",name:"原图",type:"basic"},{id:"warm",name:"暖色调",type:"basic"},{id:"cool",name:"冷色调",type:"basic"},{id:"vintage",name:"复古",type:"basic"},{id:"dramatic",name:"戏剧性",type:"basic"},{id:"monochrome",name:"黑白",type:"basic"}]}getAdvancedPresets(){return this.advancedPresets}async initializeAdvancedPresets(){if(!this.isInitialized)try{const e=Object.assign({"/src/assets/LutColorApp/lut/AZ-neutral-2019.cube":()=>R(()=>import("./AZ-neutral-2019-CdRni3tV.js"),[],import.meta.url),"/src/assets/LutColorApp/lut/CineStill-800-T-V1.0--N125.cube":()=>R(()=>import("./CineStill-800-T-V1.0--N125-B10ZZ8k9.js"),[],import.meta.url),"/src/assets/LutColorApp/lut/DENOISER_SIMPLE.cube":()=>R(()=>import("./DENOISER_SIMPLE-CAkSPmKR.js"),[],import.meta.url),"/src/assets/LutColorApp/lut/Powerful Cold.cube":()=>R(()=>import("./Powerful Cold-DnSj8wAx.js"),[],import.meta.url),"/src/assets/LutColorApp/lut/Severn.cube":()=>R(()=>import("./Severn-DkBKEYaN.js"),[],import.meta.url)});this.advancedPresets=Object.keys(e).map(n=>{const r=n.split("/").pop()||"",t=r?.replace(/\.(cube|3dl)$/,"")||"",l=this.formatPresetName(r);return{id:`advanced_${t}`,fileName:r,name:t,type:"advanced",url:n+"?raw"}}),this.isInitialized=!0,console.log(`Loaded ${this.advancedPresets.length} advanced LUT presets`)}catch(e){console.error("Failed to initialize advanced presets:",e)}}formatPresetName(e){return e.replace(/[-_]/g," ").replace(/\b\w/g,n=>n.toUpperCase()).replace(/V\d+\.\d+/g,n=>n.toUpperCase()).replace(/--N\d+/g,"").trim()}async getLutData(e){if(this.lutCache.has(e.id))return this.lutCache.get(e.id);let n;if(e.type==="basic")e.id==="identity"?n=C.createIdentityLUT(32):n=C.createPresetLUT(e.id,32);else{if(!e.url)throw new Error(`No URL provided for advanced preset: ${e.name}`);try{const t=(await import(e.url)).default,l=new File([t],e.fileName,{type:"text/plain"});n=await C.parseLUT(l),console.log(`Loaded advanced LUT: ${e.name}`)}catch(r){console.error(`Failed to load advanced LUT ${e.name}:`,r),n=C.createIdentityLUT(32)}}return this.lutCache.set(e.id,n),n}clearCache(){this.lutCache.clear()}async preloadCommonLuts(){const n=this.getBasicPresets().slice(0,3).map(r=>this.getLutData(r).catch(t=>console.warn(`Failed to preload ${r.name}:`,t)));await Promise.all(n),console.log("Common LUTs preloaded")}}const Xe="_container_1657z_1",$e="_tabHeader_1657z_6",Ve="_tabButton_1657z_11",Ye="_active_1657z_30",qe="_count_1657z_35",Ke="_tabContent_1657z_40",Ze="_loading_1657z_45",He="_spinner_1657z_55",Je="_presetGrid_1657z_71",Qe="_presetButton_1657z_76",et="_disabled_1657z_91",tt="_presetType_1657z_101",rt="_presetName_1657z_109",nt="_emptyState_1657z_125",x={container:Xe,tabHeader:$e,tabButton:Ve,active:Ye,count:qe,tabContent:Ke,loading:Ze,spinner:He,presetGrid:Je,presetButton:Qe,disabled:et,presetType:tt,presetName:rt,emptyState:nt},st=({currentPreset:p,onPresetChange:e,isLoading:n=!1})=>{const[r,t]=d.useState("basic"),[l,u]=d.useState([]),[g,h]=d.useState([]),[f,m]=d.useState(!1);d.useEffect(()=>{(async()=>{m(!0);try{const L=T.instance.getBasicPresets();u(L),await T.instance.initializeAdvancedPresets();const U=T.instance.getAdvancedPresets();h(U),console.log(`Initialized ${L.length} basic and ${U.length} advanced presets`)}catch(L){console.error("Failed to initialize presets:",L)}finally{m(!1)}})()},[]);const _=v=>{t(v)},I=v=>{n||e(v)},j=v=>p===v.id||p==="identity"&&v.id==="identity"||p==="custom"&&v.id.startsWith("advanced_"),P=r==="basic"?l:g;return s.jsxs("div",{className:x.container,children:[s.jsxs("div",{className:x.tabHeader,children:[s.jsxs("button",{className:`${x.tabButton} ${r==="basic"?x.active:""}`,onClick:()=>_("basic"),children:["基础预设",s.jsxs("span",{className:x.count,children:["(",l.length,")"]})]}),s.jsxs("button",{className:`${x.tabButton} ${r==="advanced"?x.active:""}`,onClick:()=>_("advanced"),children:["高级预设",s.jsxs("span",{className:x.count,children:["(",g.length,")"]})]})]}),s.jsx("div",{className:x.tabContent,children:f?s.jsxs("div",{className:x.loading,children:[s.jsx("div",{className:x.spinner}),s.jsx("span",{children:"加载预设中..."})]}):s.jsxs("div",{className:x.presetGrid,children:[P.map(v=>s.jsxs("button",{className:`${x.presetButton} ${j(v)?x.active:""} ${n?x.disabled:""}`,onClick:()=>I(v),disabled:n,title:v.name,children:[s.jsx("span",{className:x.presetName,children:v.name}),v.type==="advanced"&&s.jsx("span",{className:x.presetType,children:"LUT"})]},v.id)),P.length===0&&!f&&s.jsx("div",{className:x.emptyState,children:r==="basic"?"暂无基础预设":"暂无高级预设"})]})})]})},at=()=>{const p=d.useRef(null),e=d.useRef(null),n=d.useRef(null),r=d.useRef(null),[t,l]=d.useState({isLoading:!1,error:null,hasImage:!1,hasLut:!1,renderBackend:"",renderOptions:{intensity:1,brightness:0,contrast:1,saturation:1,hue:0},currentPreset:"identity",zoom:1,panX:0,panY:0,imageWidth:0,imageHeight:0,isLutLoading:!1});d.useEffect(()=>((async()=>{if(p.current){l(i=>({...i,isLoading:!0,error:null}));try{const i=await Oe.create(p.current);r.current=i,l(c=>({...c,isLoading:!1,renderBackend:i.backend==="webgpu"?"WebGPU":"WebGL2"})),await u()}catch(i){console.error("Failed to initialize render engine:",i),l(c=>({...c,isLoading:!1,error:"渲染引擎初始化失败: "+i.message}))}}})(),()=>{r.current&&r.current.dispose()}),[]);const u=async()=>{if(r.current)try{const a=C.createIdentityLUT(32);await r.current.loadLUT(a),l(i=>({...i,hasLut:!0}))}catch(a){console.error("Failed to load default LUT:",a)}},g=d.useCallback(async a=>{if(r.current){l(i=>({...i,isLoading:!0,error:null}));try{const i=new Image;i.onload=async()=>{const c=document.createElement("canvas"),b=c.getContext("2d");c.width=i.width,c.height=i.height,b.drawImage(i,0,0);const y=b.getImageData(0,0,i.width,i.height);await r.current.loadTexture(y),l(E=>({...E,isLoading:!1,hasImage:!0,imageWidth:i.width,imageHeight:i.height,zoom:1,panX:0,panY:0})),await m(),S(i.width,i.height)},i.onerror=()=>{l(c=>({...c,isLoading:!1,error:"图片加载失败"}))},i.src=URL.createObjectURL(a)}catch(i){console.error("Failed to load image:",i),l(c=>({...c,isLoading:!1,error:"图片处理失败: "+i.message}))}}},[]),h=d.useCallback(async a=>{if(r.current){l(i=>({...i,isLoading:!0,error:null}));try{const i=await C.parseLUT(a);await r.current.loadLUT(i),await m(),l(c=>({...c,isLoading:!1,hasLut:!0,currentPreset:"custom"}))}catch(i){console.error("Failed to load LUT:",i),l(c=>({...c,isLoading:!1,error:"LUT文件加载失败: "+i.message}))}}},[]),f=d.useCallback(async a=>{if(r.current){l(i=>({...i,isLutLoading:!0,currentPreset:a.id}));try{const i=await T.instance.getLutData(a);await r.current.loadLUT(i),await m(),l(c=>({...c,isLutLoading:!1,hasLut:!0}))}catch(i){console.error("Failed to apply preset:",i),l(c=>({...c,isLutLoading:!1,error:"预设应用失败: "+i.message}))}}},[]),m=async()=>{if(!r.current){console.log("No render engine");return}try{console.log("Rendering with options:",t.renderOptions),await r.current.render(t.renderOptions),console.log("Render completed")}catch(a){console.error("Render failed:",a),l(i=>({...i,error:"渲染失败: "+a.message}))}},_=d.useCallback((a,i)=>{l(c=>({...c,renderOptions:{...c.renderOptions,[a]:i}}))},[]),I=d.useCallback(()=>{l(a=>({...a,renderOptions:{intensity:1,brightness:0,contrast:1,saturation:1,hue:0}}))},[]);d.useEffect(()=>{t.hasImage&&t.hasLut&&m()},[t.renderOptions,t.hasImage,t.hasLut]);const j=d.useCallback(a=>{a.preventDefault();const i=Array.from(a.dataTransfer.files),c=i.find(y=>y.type.startsWith("image/")),b=i.find(y=>y.name.toLowerCase().endsWith(".cube")||y.name.toLowerCase().endsWith(".3dl"));c&&g(c),b&&h(b)},[g,h]),P=d.useCallback(async()=>{if(!(!r.current||!t.hasImage))try{console.log("Starting export process..."),console.log("Canvas dimensions:",p.current?.width,"x",p.current?.height),console.log("Image dimensions:",t.imageWidth,"x",t.imageHeight),await m(),await new Promise(b=>setTimeout(b,100));const a=await r.current.exportImage();if(console.log("Blob created:",a.size,"bytes, type:",a.type),a.size===0)throw new Error("导出的图片为空，可能渲染未完成");const i=URL.createObjectURL(a),c=document.createElement("a");c.href=i,c.download=`lut-processed-${Date.now()}.png`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(i),console.log("Export completed successfully"),l(b=>({...b,error:null}))}catch(a){console.error("Export failed:",a),l(i=>({...i,error:"导出失败: "+a.message}))}},[t.hasImage]),v=d.useCallback(a=>{if(!t.hasImage||!p.current)return;a.preventDefault();const i=p.current.getBoundingClientRect(),c=a.clientX-i.left-i.width/2,b=a.clientY-i.top-i.height/2,y=a.deltaY>0?.9:1.1,E=Math.max(.1,Math.min(5,t.zoom*y)),z=E/t.zoom,B=t.panX-c*(z-1),q=t.panY-b*(z-1);l(K=>({...K,zoom:E,panX:B,panY:q}))},[t.hasImage,t.zoom,t.panX,t.panY]),[L,U]=d.useState(!1),[A,W]=d.useState({x:0,y:0}),D=d.useCallback(a=>{t.hasImage&&(U(!0),W({x:a.clientX-t.panX,y:a.clientY-t.panY}))},[t.hasImage,t.panX,t.panY]),X=d.useCallback(a=>{if(!L||!t.hasImage)return;const i=a.clientX-A.x,c=a.clientY-A.y;l(b=>({...b,panX:i,panY:c}))},[L,t.hasImage,A]),k=d.useCallback(()=>{U(!1)},[]),F=d.useCallback(()=>{l(a=>({...a,zoom:1,panX:0,panY:0}))},[]),S=d.useCallback((a,i)=>{if(!p.current)return;const c=p.current.parentElement;if(!c)return;const b=c.getBoundingClientRect(),y=(b.width-40)/a,E=(b.height-40)/i,z=Math.min(y,E,1);l(B=>({...B,zoom:z,panX:0,panY:0}))},[]),M=d.useCallback(()=>{t.hasImage&&S(t.imageWidth,t.imageHeight)},[t.hasImage,t.imageWidth,t.imageHeight,S]),$=d.useCallback(()=>{l(a=>({...a,zoom:Math.min(5,a.zoom*1.2)}))},[]),V=d.useCallback(()=>{l(a=>({...a,zoom:Math.max(.1,a.zoom*.8)}))},[]),Y=De({zoomReset:N.zoomReset,zoomFit:N.zoomFit,zoomIn:N.zoomIn,zoomOut:N.zoomOut,export:N.export},{zoomReset:F,zoomFit:M,zoomIn:$,zoomOut:V,export:P});return We(Y,t.hasImage),s.jsxs("div",{className:o.container,children:[s.jsxs("div",{className:o.leftPanel,children:[s.jsx("div",{className:o.panelHeader,children:s.jsx("h3",{className:o.panelTitle,children:"LUT 预设库"})}),s.jsx("div",{className:o.panelContent,children:s.jsx(st,{currentPreset:t.currentPreset,onPresetChange:f,isLoading:t.isLutLoading})}),s.jsxs("div",{className:o.panelFooter,children:[s.jsx("button",{className:`${o.button} ${o.buttonSecondary}`,onClick:()=>n.current?.click(),children:"加载自定义LUT"}),s.jsx("input",{ref:n,type:"file",accept:".cube,.3dl",className:o.fileInput,onChange:a=>{const i=a.target.files?.[0];i&&h(i)}})]})]}),s.jsxs("div",{className:o.centerPanel,children:[s.jsxs("div",{className:o.toolbar,children:[s.jsxs("div",{className:o.toolbarLeft,children:[s.jsx("button",{className:o.button,onClick:()=>e.current?.click(),children:"选择图片"}),s.jsx("input",{ref:e,type:"file",accept:"image/*",className:o.fileInput,onChange:a=>{const i=a.target.files?.[0];i&&g(i)}})]}),t.hasImage&&s.jsxs("div",{className:o.viewControls,children:[s.jsx("button",{className:o.toolbarButton,onClick:F,title:"重置视图 (1:1)",children:"1:1"}),s.jsx("button",{className:o.toolbarButton,onClick:M,title:"适应窗口",children:"适应"}),s.jsxs("span",{className:o.zoomInfo,children:["缩放: ",(t.zoom*100).toFixed(0),"%"]})]})]}),s.jsxs("div",{className:o.canvasContainer,onDrop:j,onDragOver:a=>a.preventDefault(),onWheel:v,onMouseDown:D,onMouseMove:X,onMouseUp:k,onMouseLeave:k,children:[!t.hasImage&&s.jsxs("div",{className:o.dropZone,onClick:()=>e.current?.click(),role:"button",tabIndex:0,onKeyDown:a=>{(a.key==="Enter"||a.key===" ")&&(a.preventDefault(),e.current?.click())},children:[s.jsx("div",{className:o.dropZoneIcon,children:"🖼️"}),s.jsx("div",{className:o.dropZoneText,children:"拖拽图片到这里"}),s.jsx("div",{className:o.dropZoneSubtext,children:"或点击这里选择图片"})]}),s.jsx("canvas",{ref:p,className:o.canvas,width:t.imageWidth||800,height:t.imageHeight||600,style:{display:t.hasImage?"block":"none",transform:`translate(${t.panX}px, ${t.panY}px) scale(${t.zoom})`,cursor:L?"grabbing":t.hasImage?"grab":"default"}}),t.isLoading&&s.jsx("div",{className:o.loadingOverlay,children:s.jsx("div",{className:o.spinner})})]}),s.jsxs("div",{className:o.statusBar,children:[t.error&&s.jsx("span",{className:o.errorMessage,children:t.error}),t.hasImage&&s.jsx("span",{className:o.helpText,children:"滚轮缩放 | 拖拽平移 | Ctrl+0重置 | Ctrl+1适应 | Ctrl+E导出"}),s.jsxs("span",{className:o.renderBackend,children:["渲染后端: ",t.renderBackend]})]})]}),s.jsxs("div",{className:o.rightPanel,children:[s.jsxs("div",{className:o.panelHeader,children:[s.jsx("h3",{className:o.panelTitle,children:"调色参数"}),s.jsx("button",{className:`${o.button} ${o.buttonSecondary} ${o.resetButton}`,onClick:I,title:"重置所有参数到默认值",children:"重置"})]}),s.jsx("div",{className:o.panelContent,children:s.jsxs("div",{className:o.controlSection,children:[s.jsxs("div",{className:o.controlGroup,children:[s.jsxs("label",{className:o.controlLabel,children:["LUT强度",s.jsx("span",{className:o.sliderValue,children:t.renderOptions.intensity.toFixed(2)})]}),s.jsx("input",{type:"range",min:"0",max:"1",step:"0.01",value:t.renderOptions.intensity,className:o.slider,onChange:a=>_("intensity",parseFloat(a.target.value))})]}),s.jsxs("div",{className:o.controlGroup,children:[s.jsxs("label",{className:o.controlLabel,children:["亮度",s.jsx("span",{className:o.sliderValue,children:t.renderOptions.brightness.toFixed(2)})]}),s.jsx("input",{type:"range",min:"-0.5",max:"0.5",step:"0.01",value:t.renderOptions.brightness,className:o.slider,onChange:a=>_("brightness",parseFloat(a.target.value))})]}),s.jsxs("div",{className:o.controlGroup,children:[s.jsxs("label",{className:o.controlLabel,children:["对比度",s.jsx("span",{className:o.sliderValue,children:t.renderOptions.contrast.toFixed(2)})]}),s.jsx("input",{type:"range",min:"0.5",max:"2",step:"0.01",value:t.renderOptions.contrast,className:o.slider,onChange:a=>_("contrast",parseFloat(a.target.value))})]}),s.jsxs("div",{className:o.controlGroup,children:[s.jsxs("label",{className:o.controlLabel,children:["饱和度",s.jsx("span",{className:o.sliderValue,children:t.renderOptions.saturation.toFixed(2)})]}),s.jsx("input",{type:"range",min:"0",max:"2",step:"0.01",value:t.renderOptions.saturation,className:o.slider,onChange:a=>_("saturation",parseFloat(a.target.value))})]}),s.jsxs("div",{className:o.controlGroup,children:[s.jsxs("label",{className:o.controlLabel,children:["色相偏移",s.jsxs("span",{className:o.sliderValue,children:[(t.renderOptions.hue*360).toFixed(0),"°"]})]}),s.jsx("input",{type:"range",min:"-0.5",max:"0.5",step:"0.01",value:t.renderOptions.hue,className:o.slider,onChange:a=>_("hue",parseFloat(a.target.value))})]})]})}),s.jsx("div",{className:o.panelFooter,children:s.jsx("button",{className:o.button,onClick:P,disabled:!t.hasImage,children:"导出图片"})})]})]})};class O extends Q{static icon=w.icon;static name=w.name;static id=w.id;appRoot=null;launch(){this.openMainWindow()}openMainWindow(){const e=ee.ins.showWindow("",{title:w.name,icon:w.icon,x:w.defaultWindow.x||100,y:w.defaultWindow.y||50,width:w.defaultWindow.width,height:w.defaultWindow.height});this.appRoot=Z.createRoot(e.content),this.appRoot.render(H.createElement(at)),this.windows.set(e.id,e),e.on(te.EventType.ON_CLOSE,this.onClickClose)}onClickClose=()=>{J.ins.exitApp(O)};onExit(){this.appRoot&&(this.appRoot.unmount(),this.appRoot=null)}}export{O as LutColorApp};
