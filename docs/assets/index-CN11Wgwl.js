var T=Object.defineProperty;var X=(a,t,e)=>t in a?T(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var i=(a,t,e)=>X(a,typeof t!="symbol"?t+"":t,e);import{L as A,B as y,a as z,i as N,b as Y,D as F,g as H,C as W,N as j,M as v,V as w,c as f,d as l,S as G,R as S,G as k,F as U,e as O,P as V,f as B,W as Z,h as I,A as q,j as Q,k as _,l as K,r as u,m as d,n as J}from"./vendor-CI8W9CFo.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=e(n);fetch(n.href,o)}})();const $=""+new URL("my_stardew_valley_farm-qyeIgYac.glb",import.meta.url).href;function tt(a){return new Worker(""+new URL("navmesh-worker-BZEHHa0d.js",import.meta.url).href,{type:"module",name:a==null?void 0:a.name})}var m=(a=>(a[a.Default=0]="Default",a[a.DebugView=1]="DebugView",a))(m||{});class et{constructor(t,e=!1){i(this,"navMesh");i(this,"crowd");i(this,"playerAgent");i(this,"pathLine");i(this,"debugDrawer");i(this,"scene");i(this,"debug",!1);this.pathLine=new A(new y,new z({color:255,linewidth:10})),t.add(this.pathLine),this.scene=t,this.debug=e}async init(t){await this.initNavMesh(t),this.initCrowd()}async initNavMesh(t){return console.time("init Recast"),await N(),console.timeEnd("init Recast"),new Promise(e=>{const s={cs:.2,ch:.2,tileSize:64,walkableSlopeAngle:35,walkableHeight:1,walkableClimb:1,walkableRadius:1,maxEdgeLen:12,maxSimplificationError:1.3,minRegionArea:8,mergeRegionArea:20,maxVertsPerPoly:6,detailSampleDist:6,detailSampleMaxError:1},n=new tt;n.onmessage=c=>{console.timeEnd("Generate NavMesh");const p=c.data;this.navMesh=Y(p).navMesh,this.debug&&(this.debugDrawer=new F,this.debugDrawer.layers.set(m.DebugView),this.scene.add(this.debugDrawer),this.debugDrawer.clear(),this.debugDrawer.drawNavMesh(this.navMesh),this.debugDrawer.children.forEach(g=>{g.layers.set(m.DebugView)})),e()};const o=[];t.traverse(c=>{c instanceof v&&o.push(c)});const[r,h]=H(o);console.time("Generate NavMesh"),n.postMessage({positions:r,indices:h,config:s},[r.buffer,h.buffer])})}initCrowd(){this.crowd=new W(this.navMesh,{maxAgents:10,maxAgentRadius:1})}getRandomPosition(t={x:0,y:0,z:0}){const s=new j(this.navMesh),{success:n,status:o,randomPolyRef:r,randomPoint:h}=s.findRandomPointAroundCircle(t,2);return h}addPlayer(t){this.playerAgent=this.crowd.addAgent(t,{radius:.5,height:1,maxSpeed:6,maxAcceleration:20,collisionQueryRange:.5,pathOptimizationRange:0,separationWeight:1})}movePlayerTo(t){var e;(e=this.playerAgent)==null||e.requestMoveTarget(t)}getPlayerPosition(){var t;return(t=this.playerAgent)==null?void 0:t.position()}update(t){var e;(e=this.crowd)==null||e.update(t),this.updatePath()}updatePath(){if(!this.playerAgent)return;this.pathLine.geometry.dispose(),this.pathLine.geometry=new y;const t=[this.playerAgent.position(),...this.playerAgent.corners()];this.pathLine.geometry.setFromPoints(t)}dispose(){var t,e;this.pathLine.geometry.dispose(),this.pathLine.material.dispose(),(t=this.navMesh)==null||t.destroy(),(e=this.debugDrawer)==null||e.dispose()}}class it{constructor(t,e,s,n={}){i(this,"camera");i(this,"target");i(this,"node");i(this,"currentPosition",new w);i(this,"currentLookAt",new w);i(this,"distance");i(this,"minDistance");i(this,"maxDistance");i(this,"rotationX");i(this,"rotationY");i(this,"minRotationX");i(this,"maxRotationX");i(this,"smoothSpeed");i(this,"minHeight");i(this,"rotationSpeed");i(this,"zoomSpeed");i(this,"touchRotationSensitivity");i(this,"touchZoomSensitivity");i(this,"enableCollision");i(this,"collisionLayers");i(this,"touchStart",new f);i(this,"prevTouchDistance",0);i(this,"isPointerDown",!1);i(this,"isTwoFingerTouch",!1);i(this,"onMouseWheel",t=>{t.preventDefault();const e=t.deltaY*.01;this.zoom(e)});i(this,"onTouchStart",t=>{t.touches.length===2&&(this.isTwoFingerTouch=!0,this.prevTouchDistance=this.getTouchDistance(t))});i(this,"onTouchMove",t=>{if(this.isTwoFingerTouch&&t.touches.length===2){const e=this.getTouchDistance(t),s=(this.prevTouchDistance-e)*this.touchZoomSensitivity;this.zoom(s),this.prevTouchDistance=e}});i(this,"onTouchEnd",()=>{this.isTwoFingerTouch=!1});i(this,"onPointerDown",t=>{this.isTwoFingerTouch||(this.isPointerDown=!0,this.touchStart.set(t.clientX,t.clientY))});i(this,"onPointerMove",t=>{if(!this.isPointerDown||this.isTwoFingerTouch)return;const e=t.clientX-this.touchStart.x,s=t.clientY-this.touchStart.y;this.rotate(-e*this.touchRotationSensitivity,s*this.touchRotationSensitivity),this.touchStart.set(t.clientX,t.clientY)});i(this,"onPointerUp",()=>{this.isPointerDown=!1});this.camera=t,this.target=e,this.node=s;const{initialDistance:o=20,minDistance:r=5,maxDistance:h=30,initialRotationX:c=45,initialRotationY:p=45,minRotationX:g=-60,maxRotationX:D=60,smoothSpeed:L=.1,minHeight:R=.5,rotationSpeed:P=.5,zoomSpeed:b=1,touchRotationSensitivity:M=.5,touchZoomSensitivity:x=.2,enableCollision:E=!0,collisionLayers:C=[]}=n;this.distance=o,this.minDistance=r,this.maxDistance=h,this.rotationX=c,this.rotationY=p,this.minRotationX=g,this.maxRotationX=D,this.smoothSpeed=L,this.minHeight=R,this.rotationSpeed=P,this.zoomSpeed=b,this.touchRotationSensitivity=M,this.touchZoomSensitivity=x,this.enableCollision=E,this.collisionLayers=C,this.updateCameraPosition(),this.initControlEvent(s)}initControlEvent(t){t.addEventListener("pointerdown",this.onPointerDown),t.addEventListener("pointermove",this.onPointerMove),t.addEventListener("pointerup",this.onPointerUp),t.addEventListener("pointercancel",this.onPointerUp),t.addEventListener("touchstart",this.onTouchStart),t.addEventListener("touchmove",this.onTouchMove),t.addEventListener("touchend",this.onTouchEnd),t.addEventListener("touchcancel",this.onTouchEnd),t.addEventListener("wheel",this.onMouseWheel)}removeControlEvent(t){t.removeEventListener("pointerdown",this.onPointerDown),t.removeEventListener("pointermove",this.onPointerMove),t.removeEventListener("pointerup",this.onPointerUp),t.removeEventListener("pointercancel",this.onPointerUp),t.removeEventListener("touchstart",this.onTouchStart),t.removeEventListener("touchmove",this.onTouchMove),t.removeEventListener("touchend",this.onTouchEnd),t.removeEventListener("wheel",this.onMouseWheel)}getTouchDistance(t){const e=t.touches[0],s=t.touches[1];return Math.hypot(e.clientX-s.clientX,e.clientY-s.clientY)}rotate(t,e){this.rotationY-=t*this.rotationSpeed,this.rotationX+=e*this.rotationSpeed,this.rotationX=l.clamp(this.rotationX,this.minRotationX,this.maxRotationX)}zoom(t){this.distance=l.clamp(this.distance+t*this.zoomSpeed,this.minDistance,this.maxDistance)}updateCameraPosition(){var n;const t=new G(this.distance,l.degToRad(90-this.rotationX),l.degToRad(this.rotationY)),e=new w;e.setFromSpherical(t);const s=e.clone().normalize();if(this.enableCollision){const o=new S(this.target.position.clone(),s,this.camera.near,this.maxDistance);o.layers.set(m.Default),this.collisionLayers.length>0&&this.collisionLayers.forEach(h=>{o.layers.enable(h)}),o.layers.disable(m.DebugView);const r=o.intersectObjects(((n=this.target.parent)==null?void 0:n.children)||[],!0).filter(h=>h.distance>0);if(r.length>0){const h=r[0],c=Math.max(this.minDistance,h.distance-.5);e.copy(s).multiplyScalar(c)}}e.add(this.target.position),e.y<this.minHeight&&(e.y=this.minHeight),this.currentPosition.lerp(e,this.smoothSpeed),this.currentLookAt.lerp(this.target.position,this.smoothSpeed),this.camera.position.copy(this.currentPosition),this.camera.lookAt(this.currentLookAt)}setTarget(t){this.target=t}setDistance(t){this.distance=l.clamp(t,this.minDistance,this.maxDistance)}setRotation(t,e){this.rotationX=l.clamp(t,this.minRotationX,this.maxRotationX),this.rotationY=e}getConfig(){return{initialDistance:this.distance,minDistance:this.minDistance,maxDistance:this.maxDistance,minRotationX:this.minRotationX,maxRotationX:this.maxRotationX,initialRotationX:this.rotationX,initialRotationY:this.rotationY,minHeight:this.minHeight,smoothSpeed:this.smoothSpeed,rotationSpeed:this.rotationSpeed,zoomSpeed:this.zoomSpeed,touchRotationSensitivity:this.touchRotationSensitivity,touchZoomSensitivity:this.touchZoomSensitivity,enableCollision:this.enableCollision,collisionLayers:this.collisionLayers}}update(){this.updateCameraPosition()}dispose(){this.removeControlEvent(this.node)}}const st=new k;new U;class nt{constructor(t){i(this,"canvas");i(this,"renderer");i(this,"scene",new O);i(this,"camera",new V(60,window.innerWidth/window.innerHeight,.1,1e3));i(this,"thirdCamera");i(this,"mapScene");i(this,"player");i(this,"navigationSystem");i(this,"clock",new B(!0));i(this,"onMouseDown",(()=>{const t=new S,e=new f;return s=>{if(s.button!==2)return;const{clientX:n,clientY:o}=s,r=this.canvas.getBoundingClientRect();e.x=(n-r.left)/this.canvas.offsetWidth*2-1,e.y=-((o-r.top)/this.canvas.offsetHeight)*2+1,t.setFromCamera(e,this.camera);const h=t.intersectObject(this.mapScene);if(h.length>0){const c=h[0].point;this.navigationSystem.movePlayerTo(c)}}})());i(this,"onResize",()=>{this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()});i(this,"onUpdate",()=>{var e,s;const t=this.clock.getDelta();this.renderer.render(this.scene,this.camera),(e=this.navigationSystem)==null||e.update(t),(s=this.navigationSystem)!=null&&s.getPlayerPosition()&&this.player.position.copy(this.navigationSystem.getPlayerPosition()),this.thirdCamera.update()});this.canvas=t}async start(){this.initScene(),await this.addMap(),this.navigationSystem=new et(this.scene),await this.navigationSystem.init(this.mapScene);const t=this.navigationSystem.getRandomPosition();this.navigationSystem.addPlayer(t),this.renderer.setAnimationLoop(this.onUpdate),this.canvas.addEventListener("mousedown",this.onMouseDown)}initScene(){const t=this.renderer=new Z({canvas:this.canvas,powerPreference:"high-performance",antialias:!0});t.setClearColor(16777215),t.shadowMap.enabled=!0,t.shadowMap.type=I,this.onResize(),window.addEventListener("resize",this.onResize);const e=new q(16777215,2);this.scene.add(e);const s=new Q(16777215,6);s.shadow.camera.top=100,s.shadow.camera.bottom=-100,s.shadow.camera.left=-100,s.shadow.camera.right=100,s.shadow.bias=-.001,s.shadow.mapSize.set(4096,4096),s.shadow.radius=100,s.position.set(50,50,50),s.castShadow=!0,this.scene.add(s),this.player=new v(new _(1,1,1),new K({color:16711680})),this.player.castShadow=!0,this.player.receiveShadow=!0,this.scene.add(this.player),this.thirdCamera=new it(this.camera,this.player,this.canvas,{enableCollision:!0,collisionLayers:[m.Default]})}async addMap(){const t=await st.loadAsync($);this.mapScene=t.scene,this.mapScene.scale.set(5,5,5),this.scene.add(t.scene),t.scene.traverse(e=>{e instanceof v&&(e.castShadow=!0,e.receiveShadow=!0)})}destroy(){var t;this.renderer.dispose(),(t=this.navigationSystem)==null||t.dispose()}}function ot(){const[a,t]=u.useState(!0),e=u.useRef(null),s=u.useRef(null);return u.useEffect(()=>((async()=>{s.current=new nt(e.current),await s.current.start(),t(!1)})(),()=>{var o;(o=s.current)==null||o.destroy()}),[]),d.jsxs("div",{className:"app",children:[d.jsx("canvas",{className:"gameCanvas",onContextMenu:n=>n.preventDefault(),ref:e}),a&&d.jsxs("div",{className:"loading",children:[d.jsx("div",{className:"loading-spinner"}),d.jsx("div",{className:"loading-text",children:"Loading..."})]})]})}J(document.getElementById("root")).render(d.jsx(ot,{}));
