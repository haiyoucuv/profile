var w=Object.defineProperty;var f=(i,e,s)=>e in i?w(i,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):i[e]=s;var n=(i,e,s)=>f(i,typeof e!="symbol"?e+"":e,s);import{G as g,F as y,S as v,P as M,C as L,R as S,V as b,W as x,a as P,A,D as R,M as l,B as C,b as N,L as E,c as u,d as D,O as W,i as z,e as G,f as O,g as j,h as B,N as k,r as p,j as m,k as F}from"./vendor-Cyngr210.js";function q(){import.meta.url,import("_").catch(()=>1),async function*(){}().next()}(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&r(o)}).observe(document,{childList:!0,subtree:!0});function s(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function r(t){if(t.ep)return;t.ep=!0;const a=s(t);fetch(t.href,a)}})();const H=""+new URL("game_map-DLxz9SvN.glb",import.meta.url).href;function _(i){return new Worker(""+new URL("navmesh-worker-D_d9yitz.js",import.meta.url).href,{type:"module",name:i==null?void 0:i.name})}const I=new g;new y;class U{constructor(e){n(this,"canvas");n(this,"renderer");n(this,"scene",new v);n(this,"camera",new M(75,window.innerWidth/window.innerHeight,.1,1e3));n(this,"mapScene");n(this,"controls");n(this,"player");n(this,"playerAgent");n(this,"navMesh");n(this,"crowd");n(this,"pathLine");n(this,"clock",new L(!0));n(this,"initNavMesh",async()=>new Promise(async e=>{console.time("init recast"),await z(),console.timeEnd("init recast");const s={cs:.2,ch:.5,tileSize:64,walkableSlopeAngle:35,walkableHeight:1,walkableClimb:1,walkableRadius:1,maxEdgeLen:12,maxSimplificationError:1.3,minRegionArea:8,mergeRegionArea:20,maxVertsPerPoly:6,detailSampleDist:6,detailSampleMaxError:1},r=new _;r.onmessage=c=>{console.timeEnd("Generate NavMesh");const h=c.data;this.navMesh=G(h).navMesh;const d=new O;this.scene.add(d),d.clear(),d.drawNavMesh(this.navMesh),e()};const t=[];this.mapScene.traverse(c=>{c instanceof l&&t.push(c)});const[a,o]=j(t);console.time("Generate NavMesh"),r.postMessage({positions:a,indices:o,config:s},[a.buffer,o.buffer])}));n(this,"initCrowd",async()=>{this.crowd=new B(this.navMesh,{maxAgents:10,maxAgentRadius:1});const e={x:0,y:0,z:0},s=2,r=new k(this.navMesh),{success:t,status:a,randomPolyRef:o,randomPoint:c}=r.findRandomPointAroundCircle(e,s);this.playerAgent=this.crowd.addAgent(c,{radius:.5,height:1,maxSpeed:6,maxAcceleration:20,collisionQueryRange:.5,pathOptimizationRange:0,separationWeight:1})});n(this,"onUpdate",()=>{var s;const e=this.clock.getDelta();this.renderer.render(this.scene,this.camera),(s=this.crowd)==null||s.update(e),this.playerAgent&&(this.player.position.copy(this.playerAgent.position()),this.updatePath()),this.controls.update()});this.canvas=e,this.start()}async start(){this.initScene(),await this.addMap(),await this.initNavMesh(),await this.initCrowd(),this.renderer.setAnimationLoop(this.onUpdate);const e=new S,s=new b;this.canvas.addEventListener("mousedown",r=>{if(r.button!==2)return;const{clientX:t,clientY:a}=r,o=this.canvas.getBoundingClientRect();s.x=(t-o.left)/this.canvas.offsetWidth*2-1,s.y=-((a-o.top)/this.canvas.offsetHeight)*2+1,e.setFromCamera(s,this.camera);const c=e.intersectObject(this.mapScene);if(c.length>0){const h=c[0].point;this.playerAgent.requestMoveTarget(h)}})}initScene(){const e=this.renderer=new x({canvas:this.canvas,powerPreference:"high-performance",antialias:!0});e.setSize(window.innerWidth,window.innerHeight),e.setPixelRatio(window.devicePixelRatio),e.shadowMap.enabled=!0,e.shadowMap.type=P;const s=()=>{e.setSize(window.innerWidth,window.innerHeight),this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()};s(),window.addEventListener("resize",s),this.camera.position.set(-10,20,15);const r=new A(16777215,2);this.scene.add(r);const t=new R(16777215,6);t.castShadow=!0,t.shadow.camera.top=100,t.shadow.camera.bottom=-100,t.shadow.camera.left=-100,t.shadow.camera.right=100,t.shadow.bias=-1e-4,t.shadow.mapSize.set(4096,4096),t.position.set(5,5,5),t.shadow.normalBias=.05,t.shadow.radius=100,t.position.set(50,200,50),this.scene.add(t),this.player=new l(new C(1,1,1),new N({color:16711680})),this.player.castShadow=!0,this.player.receiveShadow=!0,this.scene.add(this.player),this.pathLine=new E(new u,new D({color:255,linewidth:10})),this.scene.add(this.pathLine),this.controls=new W(this.camera,this.canvas),this.controls.target=this.player.position,this.controls.enableDamping=!0,this.controls.maxDistance=50,this.controls.enableZoom=!0,this.controls.enablePan=!0,this.controls.maxPolarAngle=Math.PI/2,this.controls.minPolarAngle=0}async addMap(){const e=await I.loadAsync(H);this.mapScene=e.scene,this.mapScene.scale.set(5,5,5),this.scene.add(e.scene),e.scene.traverse(s=>{s instanceof l&&(s.castShadow=!0,s.receiveShadow=!0)})}updatePath(){const e=[this.playerAgent.position(),...this.playerAgent.corners()];this.pathLine.geometry.dispose(),this.pathLine.geometry=new u,this.pathLine.geometry.setFromPoints(e)}destroy(){this.renderer.dispose()}}function Q(){const i=p.useRef(null),e=p.useRef(null);return p.useEffect(()=>(e.current=new U(i.current),()=>{e.current.destroy()}),[]),m.jsx("div",{className:"app",children:m.jsx("canvas",{className:"gameCanvas",ref:i})})}F(document.getElementById("root")).render(m.jsx(Q,{}));export{q as __vite_legacy_guard};
