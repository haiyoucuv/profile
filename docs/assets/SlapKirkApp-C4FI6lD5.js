const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./index-Djk7wEGZ.js","./graph_model-HyHReiP6.js","./index-BigcdQAd.js","./index-D3islUNp.css","./hand-pose-detection.esm-DyaCaHd6.js"])))=>i.map(i=>d[i]);
import{_ as T,k as A,b as N,R as K,A as $,r as m,j as l}from"./index-BigcdQAd.js";import{V as G,W as H,a as O}from"./VirtualApp-Dg1sZoNX.js";var w=(o=>(o.NONE="none",o.READY="ready",o.SLAP="slap",o.FIST="fist",o.PEACE="peace",o))(w||{});class V{model=null;videoElement=null;canvas=null;ctx=null;isInitialized=!1;isDetecting=!1;gestureHistory=[];HISTORY_SIZE=5;lastDetectionResult=[];debugModeEnabled=!1;lastDebugUpdate=0;advancedDebugMode=!1;SLAP_VELOCITY_THRESHOLD=.15;CONFIDENCE_THRESHOLD=.7;async initialize(t={width:640,height:480,facingMode:"user"}){try{if(console.log("初始化AI手势识别引擎..."),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("浏览器不支持摄像头访问");this.videoElement=document.createElement("video"),this.videoElement.width=t.width,this.videoElement.height=t.height,this.videoElement.autoplay=!0,this.videoElement.muted=!0,this.videoElement.playsInline=!0,this.canvas=document.createElement("canvas"),this.canvas.width=t.width,this.canvas.height=t.height,this.ctx=this.canvas.getContext("2d");const s=await navigator.mediaDevices.getUserMedia({video:{width:t.width,height:t.height,facingMode:t.facingMode}});return this.videoElement.srcObject=s,await this.videoElement.play(),await this.loadModel(),this.isInitialized=!0,console.log("AI手势识别引擎初始化成功"),!0}catch(s){return console.error("初始化AI引擎失败:",s),!1}}async loadModel(){try{console.log("开始加载MediaPipe Hands模型...");const[t,s]=await Promise.all([T(()=>import("./index-Djk7wEGZ.js"),__vite__mapDeps([0,1,2,3]),import.meta.url),T(()=>import("./hand-pose-detection.esm-DyaCaHd6.js"),__vite__mapDeps([4,2,3,1]),import.meta.url)]);await t.ready(),console.log("TensorFlow.js后端就绪:",t.getBackend()),this.model=await s.createDetector(s.SupportedModels.MediaPipeHands,{runtime:"tfjs",modelType:"lite",maxHands:2}),console.log("MediaPipe Hands模型加载成功")}catch(t){console.error("模型加载失败，使用模拟模式:",t),this.model=null,await new Promise(s=>setTimeout(s,1e3))}}async startDetection(){!this.isInitialized||this.isDetecting||(this.isDetecting=!0,this.detectionLoop())}stopDetection(){this.isDetecting=!1}async detectionLoop(){if(!(!this.isDetecting||!this.videoElement)){try{const t=await this.detectGesture();this.addToHistory(t),t.type!=="none"&&this.onGestureDetected?.(t),this.debugModeEnabled&&Date.now()-this.lastDebugUpdate>100&&(this.updateDebugCanvas(),this.lastDebugUpdate=Date.now())}catch(t){console.error("手势检测错误:",t)}setTimeout(()=>this.detectionLoop(),33)}}async detectGesture(){if(!this.videoElement)return{type:"none",confidence:0};try{if(this.model){const t=await this.model.estimateHands(this.videoElement,{flipHorizontal:!0});return this.lastDetectionResult=t,t&&t.length>0?this.classifyGesture(t):{type:"none",confidence:0}}else return this.simulateGestureDetection()}catch(t){return console.error("手势检测失败:",t),{type:"none",confidence:0}}}simulateGestureDetection(){const t=this.generateSimulatedHandData();this.lastDetectionResult=[t];const s=Math.random();return s<.05?{type:"slap",confidence:.8+Math.random()*.2,landmarks:t.landmarks,velocity:{x:(Math.random()-.5)*.4,y:(Math.random()-.5)*.2,magnitude:.15+Math.random()*.1}}:s<.6?{type:"ready",confidence:.7+Math.random()*.3,landmarks:t.landmarks}:{type:"none",confidence:.6+Math.random()*.2,landmarks:t.landmarks}}generateSimulatedHandData(){console.log("开始生成模拟手部数据...");const t=[],s=Date.now()/1e3,e=.5+Math.sin(s*.5)*.1,a=.5+Math.cos(s*.3)*.1;t[0]={x:e,y:a,z:0},console.log(`手腕位置: (${e.toFixed(3)}, ${a.toFixed(3)})`);const i=[{base:[.45,.45],joints:4,spread:.08},{base:[.48,.35],joints:4,spread:.12},{base:[.5,.3],joints:4,spread:.15},{base:[.52,.35],joints:4,spread:.12},{base:[.55,.4],joints:4,spread:.1}];let n=1;for(i.forEach((p,u)=>{const f=e+(p.base[0]-.5),d=a+(p.base[1]-.5);for(let c=0;c<p.joints;c++){const g=(c+1)/p.joints,x=u*.3+Math.sin(s+u)*.2,y=f+Math.cos(x)*p.spread*g,v=d+Math.sin(x)*p.spread*g,S=Math.sin(s*2+u+c)*.02;t[n]={x:y,y:v,z:S},n++}});t.length<21;)t.push({x:e,y:a,z:0});console.log(`模拟手部数据生成完成，关键点数量: ${t.length}`);const r={landmarks:t,keypoints:t,score:.85+Math.sin(s)*.1,handedness:{categoryName:"Left",displayName:"左手 (模拟)",score:.9+Math.cos(s*.5)*.05}};return console.log("模拟手部数据:",r),r}classifyGesture(t){if(!t||t.length===0)return{type:"none",confidence:0};const s=t[0],e=s.keypoints||s.landmarks,a=s.score||s.handedness?.score||.8,i=e.map(r=>({x:r.x,y:r.y,z:r.z||0})),n=this.calculateVelocity(i);return this.isPeaceSign(i)?{type:"peace",confidence:a,landmarks:i,velocity:n}:this.isFist(i)?{type:"fist",confidence:a,landmarks:i,velocity:n}:this.isPalmOpen(i)?n.magnitude>this.SLAP_VELOCITY_THRESHOLD&&Math.abs(n.x)>Math.abs(n.y)?{type:"slap",confidence:a,landmarks:i,velocity:n}:{type:"ready",confidence:a,landmarks:i,velocity:n}:{type:"none",confidence:0}}isPalmOpen(t){if(!t||t.length<21)return!1;const s=[4,8,12,16,20],e=[3,6,10,14,18],a=t[0];let i=0;for(let n=0;n<s.length;n++){const r=s[n],p=e[n];if(r<t.length&&p<t.length){const u=t[r],f=t[p],d=Math.sqrt(Math.pow(u.x-f.x,2)+Math.pow(u.y-f.y,2));Math.sqrt(Math.pow(u.x-a.x,2)+Math.pow(u.y-a.y,2))>d*1.2&&i++}}return i>=3}isFist(t){if(!t||t.length<21)return!1;const s=[4,8,12,16,20],e=t[9];let a=0;for(const i of s)if(i<t.length){const n=t[i];Math.sqrt(Math.pow(n.x-e.x,2)+Math.pow(n.y-e.y,2))<.1&&a++}return a>=4}isPeaceSign(t){if(!t||t.length<21)return!1;const s=t[8],e=t[12],a=t[16],i=t[20],n=t[4],r=t[9],p=Math.sqrt(Math.pow(s.x-r.x,2)+Math.pow(s.y-r.y,2)),u=Math.sqrt(Math.pow(e.x-r.x,2)+Math.pow(e.y-r.y,2)),f=Math.sqrt(Math.pow(a.x-r.x,2)+Math.pow(a.y-r.y,2)),d=Math.sqrt(Math.pow(i.x-r.x,2)+Math.pow(i.y-r.y,2)),c=Math.sqrt(Math.pow(n.x-r.x,2)+Math.pow(n.y-r.y,2)),g=p>.15,x=u>.15,y=f<.12,v=d<.12,S=c<.12;return g&&x&&y&&v&&S}calculateVelocity(t){if(this.gestureHistory.length<2||!t||t.length===0)return{x:0,y:0,magnitude:0};const s=9,e=t[s]||t[0];let a=null;for(let f=this.gestureHistory.length-1;f>=0;f--){const d=this.gestureHistory[f].landmarks;if(d&&d.length>s){a=d[s]||d[0];break}}if(!a)return{x:0,y:0,magnitude:0};const i=e.x-a.x,n=e.y-a.y,r=Math.sqrt(i*i+n*n),p=.7,u=this.gestureHistory[this.gestureHistory.length-1].velocity;return u?{x:p*i+(1-p)*u.x,y:p*n+(1-p)*u.y,magnitude:p*r+(1-p)*u.magnitude}:{x:i,y:n,magnitude:r}}addToHistory(t){this.gestureHistory.push(t),this.gestureHistory.length>this.HISTORY_SIZE&&this.gestureHistory.shift()}getVideoElement(){return this.videoElement}getDebugCanvas(){return this.canvas}updateDebugCanvas(){if(!this.ctx||!this.canvas||!this.debugModeEnabled){console.log("调试更新跳过:",{ctx:!!this.ctx,canvas:!!this.canvas,debugMode:this.debugModeEnabled});return}try{console.log("开始更新调试画布..."),this.testCanvasDrawing(),this.drawFullHandLandmarks()}catch(t){console.error("调试画布更新失败:",t)}}testCanvasDrawing(){if(!this.ctx||!this.canvas){console.log("Canvas测试失败: 没有ctx或canvas");return}console.log(`Canvas尺寸: ${this.canvas.width} x ${this.canvas.height}`),this.ctx.fillStyle="#FF0000",this.ctx.fillRect(50,50,100,100),console.log("红色方块已绘制在 (50,50) 尺寸 100x100"),this.ctx.fillStyle="#00FF00",this.ctx.beginPath(),this.ctx.arc(200,100,30,0,2*Math.PI),this.ctx.fill(),console.log("绿色圆圈已绘制在 (200,100) 半径 30"),this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 20px Arial",this.ctx.fillText("Canvas测试",50,200),console.log("文字已绘制")}drawFullHandLandmarks(){if(!this.ctx||!this.canvas){console.log("调试绘制失败: Canvas或Context不可用");return}try{this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),console.log(`调试绘制: 检测到${this.lastDetectionResult.length}只手`),this.lastDetectionResult&&this.lastDetectionResult.length>0?this.lastDetectionResult.forEach((t,s)=>{console.log(`绘制第${s+1}只手，关键点数量:`,t.landmarks?.length||t.keypoints?.length||0),this.drawHandWithAllLandmarks(t,s)}):console.log("调试绘制: 没有手部数据"),this.drawDebugInfoPanel()}catch(t){console.error("完整手部关键点绘制失败:",t)}}drawHandWithAllLandmarks(t,s){if(!this.ctx||!this.canvas){console.log("绘制手部失败: 没有ctx或canvas");return}try{const e=t.keypoints||t.landmarks;if(console.log(`手部数据检查 - Hand ${s}:`,{hasKeypoints:!!t.keypoints,hasLandmarks:!!t.landmarks,landmarksLength:e?.length||0,firstPoint:e?.[0]}),!e||e.length===0){console.log(`手部 ${s} 没有关键点数据`);return}console.log(`开始绘制手部 ${s}，关键点数量: ${e.length}`),this.ctx.fillStyle="#FFFF00",this.ctx.fillRect(300,50+s*50,50,30),this.ctx.fillStyle="#000000",this.ctx.font="12px Arial",this.ctx.fillText(`Hand ${s}`,305,70+s*50);const a=[[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[5,9],[9,10],[10,11],[11,12],[9,13],[13,14],[14,15],[15,16],[13,17],[17,18],[18,19],[19,20],[0,17]],i=["#00FF44","#FF4400","#4400FF","#FFAA00"],n=i[s%i.length];this.ctx.strokeStyle=n,this.ctx.lineWidth=4,this.ctx.globalAlpha=.9,this.ctx.lineCap="round",a.forEach(([d,c])=>{if(d<e.length&&c<e.length){const g=e[d],x=e[c],y=this.canvas.width-g.x,v=g.y,S=this.canvas.width-x.x,_=x.y;this.ctx.beginPath(),this.ctx.moveTo(y,v),this.ctx.lineTo(S,_),this.ctx.stroke()}}),this.ctx.fillStyle=n,this.ctx.globalAlpha=1,e.forEach((d,c)=>{const g=this.canvas.width-d.x,x=d.y;let y=4;c===0?y=12:[4,8,12,16,20].includes(c)?y=8:[2,3,6,7,10,11,14,15,18,19].includes(c)&&(y=6),this.ctx.fillStyle=n,this.ctx.beginPath(),this.ctx.arc(g,x,y,0,2*Math.PI),this.ctx.fill(),this.ctx.strokeStyle="#FFFFFF",this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(g,x,y,0,2*Math.PI),this.ctx.stroke(),[0,4,8,12,16,20].includes(c)&&(this.ctx.fillStyle="#000000",this.ctx.font="bold 10px Arial",this.ctx.textAlign="center",this.ctx.fillText(c.toString(),g,x+3),this.ctx.textAlign="left")}),console.log(`手部 ${s} 所有关键点绘制完成`);const r=t.score||t.handedness?.score||0,p=t.handedness?.categoryName||t.handedness?.displayName||`Hand ${s+1}`;this.ctx.fillStyle=n,this.ctx.font="bold 14px Arial",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=2;const u=`${p} ${(r*100).toFixed(0)}%`,f=30+s*20;this.ctx.strokeText(u,15,f),this.ctx.fillText(u,15,f)}catch(e){console.error(`绘制第${s+1}只手失败:`,e)}}drawDebugInfoPanel(){if(!(!this.ctx||!this.canvas))try{const t=[`检测到手数: ${this.lastDetectionResult.length}`,`模型: ${this.model?"TensorFlow.js":"模拟模式"}`];this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(this.canvas.width-200,10,190,50),this.ctx.fillStyle="#00D4FF",this.ctx.font="bold 11px Arial",t.forEach((s,e)=>{this.ctx.fillText(s,this.canvas.width-190,28+e*16)})}catch(t){console.error("调试信息面板绘制失败:",t)}}drawBasicDebugInfo(){if(!(!this.ctx||!this.canvas))try{const t=["调试模式: 基础模式",`检测到手数: ${this.lastDetectionResult.length}`,`模型状态: ${this.model?"TensorFlow.js":"模拟模式"}`,`画布尺寸: ${this.canvas.width}x${this.canvas.height}`,"提示: 双击开启关键点显示"];this.ctx.fillStyle="rgba(0, 0, 0, 0.8)",this.ctx.fillRect(10,10,320,130),this.ctx.fillStyle="#00D4FF",this.ctx.font="bold 14px Arial",t.forEach((s,e)=>{this.ctx.fillText(s,15,35+e*20)}),this.lastDetectionResult&&this.lastDetectionResult.length>0?(this.ctx.fillStyle="#00FF44",this.ctx.font="bold 16px Arial",this.ctx.fillText("✋ 检测到手部",15,155),this.lastDetectionResult.forEach((s,e)=>{const a=s.score||s.handedness?.score||0,i=s.handedness?.displayName||`Hand ${e+1}`;this.ctx.fillStyle=e===0?"#00FF44":"#FF4400",this.ctx.font="12px Arial",this.ctx.fillText(`${i}: ${(a*100).toFixed(1)}%`,150,155+e*15)}),this.advancedDebugMode&&this.drawSimplifiedLandmarks()):(this.ctx.fillStyle="#FFAA00",this.ctx.font="14px Arial",this.ctx.fillText("👋 请将手放在摄像头前",15,155))}catch(t){console.error("基础调试信息绘制失败:",t)}}drawSimplifiedLandmarks(){if(!(!this.ctx||!this.canvas||!this.lastDetectionResult))try{this.lastDetectionResult.forEach((t,s)=>{const e=t.keypoints||t.landmarks;if(!e||e.length===0)return;const a=[0,4,8,12,16,20],i=["#00FF44","#FF4400","#4400FF","#FFFF00"],n=i[s%i.length];this.ctx.fillStyle=n,this.ctx.strokeStyle=n,this.ctx.lineWidth=2,a.forEach((r,p)=>{if(r<e.length){const u=e[r],f=u.x*this.canvas.width,d=u.y*this.canvas.height;this.ctx.beginPath(),this.ctx.arc(f,d,r===0?8:5,0,2*Math.PI),this.ctx.fill(),r===0&&(this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 10px Arial",this.ctx.fillText("手腕",f+10,d-10),this.ctx.fillStyle=n)}})})}catch(t){console.error("简化关键点绘制失败:",t)}}drawSingleHand(t,s){if(!(!this.ctx||!this.canvas))try{const e=t.keypoints||t.landmarks;if(!e||e.length===0)return;const a=[[0,1],[1,2],[2,3],[3,4],[0,5],[5,6],[6,7],[7,8],[5,9],[9,10],[10,11],[11,12],[9,13],[13,14],[14,15],[15,16],[13,17],[17,18],[18,19],[19,20],[0,17]],i=["#00FF44","#FF4400","#4400FF","#FFFF00"],n=i[s%i.length];this.ctx.strokeStyle=n,this.ctx.fillStyle=n,this.ctx.lineWidth=3,this.ctx.beginPath(),a.forEach(([d,c])=>{if(d<e.length&&c<e.length){const g=e[d],x=e[c],y=g.x*this.canvas.width,v=g.y*this.canvas.height,S=x.x*this.canvas.width,_=x.y*this.canvas.height;this.ctx.moveTo(y,v),this.ctx.lineTo(S,_)}}),this.ctx.stroke(),e.forEach((d,c)=>{const g=d.x*this.canvas.width,x=d.y*this.canvas.height;let y=4;c===0?y=8:[4,8,12,16,20].includes(c)&&(y=6),this.ctx.beginPath(),this.ctx.arc(g,x,y,0,2*Math.PI),this.ctx.fill(),[0,4,8,12,16,20].includes(c)&&(this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 12px Arial",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=3,this.ctx.strokeText(c.toString(),g+8,x-8),this.ctx.fillText(c.toString(),g+8,x-8),this.ctx.fillStyle=n,this.ctx.strokeStyle=n,this.ctx.lineWidth=3)});const r=t.score||t.handedness?.score||0,p=t.handedness?.categoryName||t.handedness?.displayName||`Hand ${s+1}`;this.ctx.fillStyle="#FFFFFF",this.ctx.font="bold 14px Arial",this.ctx.strokeStyle="#000000",this.ctx.lineWidth=3;const u=`${p} (${(r*100).toFixed(1)}%)`,f=30+s*25;this.ctx.strokeText(u,10,f),this.ctx.fillText(u,10,f)}catch(e){console.error(`绘制第${s+1}只手失败:`,e)}}drawDebugInfo(){if(!this.ctx||!this.canvas)return;const t=[`检测到手数: ${this.lastDetectionResult.length}`,"检测频率: ~30fps",`模型状态: ${this.model?"TensorFlow.js":"模拟模式"}`,`分辨率: ${this.canvas.width}x${this.canvas.height}`];this.ctx.fillStyle="rgba(0, 0, 0, 0.7)",this.ctx.fillRect(10,this.canvas.height-120,300,110),this.ctx.fillStyle="#00D4FF",this.ctx.font="bold 12px Arial",t.forEach((e,a)=>{this.ctx.fillText(e,15,this.canvas.height-95+a*18)});const s=["● 0: 手腕  ● 4,8,12,16,20: 指尖","● 绿色: 第一只手  ● 红色: 第二只手"];this.ctx.fillStyle="#FFFFFF",this.ctx.font="10px Arial",s.forEach((e,a)=>{this.ctx.fillText(e,15,this.canvas.height-25+a*12)})}drawHandLandmarks(t,s){this.updateDebugCanvas()}setDebugMode(t,s=!1){if(console.log(`设置调试模式: ${t}, 高级模式: ${s}`),this.debugModeEnabled=t,this.advancedDebugMode=s,t){if(console.log("调试模式已启用，准备绘制手部关键点..."),this.lastDetectionResult.length===0){const e=this.generateSimulatedHandData();this.lastDetectionResult=[e],console.log("生成测试手部数据")}setTimeout(()=>{this.lastDebugUpdate=0,this.updateDebugCanvas()},100)}else this.ctx&&this.canvas&&requestAnimationFrame(()=>{this.ctx&&this.canvas&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)})}enableAdvancedDebug(){this.debugModeEnabled&&(this.advancedDebugMode=!0,console.log("启用高级调试模式（关键点显示）"),this.updateDebugCanvas())}disableAdvancedDebug(){this.advancedDebugMode=!1,console.log("关闭高级调试模式"),this.debugModeEnabled&&this.updateDebugCanvas()}getDebugMode(){return this.debugModeEnabled}getAdvancedDebugMode(){return this.advancedDebugMode}onGestureDetected;dispose(){this.stopDetection(),this.videoElement?.srcObject&&this.videoElement.srcObject.getTracks().forEach(s=>s.stop()),this.videoElement=null,this.canvas=null,this.ctx=null,this.model=null,this.isInitialized=!1}}var k=(o=>(o.LOADING="loading",o.CALIBRATING="calibrating",o.READY="ready",o.PLAYING="playing",o.PAUSED="paused",o))(k||{});class q{stats={totalSlaps:0,currentCombo:0,maxCombo:0,accuracy:0,sessionTime:0};gameState="loading";sessionStartTime=0;lastSlapTime=0;COMBO_TIMEOUT=2e3;onStatsUpdate;onGameStateChange;onSlapEffect;constructor(){this.loadFromStorage()}startSession(){this.gameState="playing",this.sessionStartTime=Date.now(),this.onGameStateChange?.(this.gameState),console.log("游戏会话开始")}pauseGame(){this.gameState==="playing"&&(this.gameState="paused",this.updateSessionTime(),this.onGameStateChange?.(this.gameState))}resumeGame(){this.gameState==="paused"&&(this.gameState="playing",this.sessionStartTime=Date.now()-this.stats.sessionTime*1e3,this.onGameStateChange?.(this.gameState))}handleGesture(t){if(this.gameState==="playing"){switch(t.type){case w.SLAP:this.handleSlap(t);break;case w.FIST:this.handleReset();break;case w.PEACE:this.handleSpecialGesture();break}this.updateSessionTime(),this.saveToStorage()}}handleSlap(t){const s=Date.now(),e=t.velocity?.magnitude||.5;this.stats.totalSlaps++,s-this.lastSlapTime<this.COMBO_TIMEOUT?this.stats.currentCombo++:this.stats.currentCombo=1,this.stats.currentCombo>this.stats.maxCombo&&(this.stats.maxCombo=this.stats.currentCombo),this.lastSlapTime=s;const a=Math.min(e*2,1);this.onSlapEffect?.(a),this.onStatsUpdate?.(this.stats),console.log(`扇击！强度: ${e.toFixed(2)}, 连击: ${this.stats.currentCombo}`)}handleReset(){this.stats.currentCombo=0,this.onStatsUpdate?.(this.stats),console.log("重置连击")}handleSpecialGesture(){console.log("触发特殊效果！"),this.onSlapEffect?.(1.5)}updateSessionTime(){this.gameState==="playing"&&this.sessionStartTime>0&&(this.stats.sessionTime=(Date.now()-this.sessionStartTime)/1e3)}saveToStorage(){try{const t={stats:this.stats};localStorage.setItem("slapkirk_game_data",JSON.stringify(t))}catch(t){console.warn("保存游戏数据失败:",t)}}loadFromStorage(){try{const t=localStorage.getItem("slapkirk_game_data");if(t){const s=JSON.parse(t);s.stats&&(this.stats={...this.stats,...s.stats},this.stats.currentCombo=0,this.stats.sessionTime=0)}}catch(t){console.warn("加载游戏数据失败:",t)}}resetAllData(){this.stats={totalSlaps:0,currentCombo:0,maxCombo:0,accuracy:0,sessionTime:0},this.saveToStorage(),this.onStatsUpdate?.(this.stats),console.log("所有数据已重置")}getStats(){return this.updateSessionTime(),{...this.stats}}getGameState(){return this.gameState}setGameState(t){this.gameState=t,this.onGameStateChange?.(t)}formatTime(t){const s=Math.floor(t/60),e=Math.floor(t%60);return`${s.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`}getSlapRate(){return this.stats.sessionTime===0?0:this.stats.totalSlaps/this.stats.sessionTime*60}}class P{static KIRK_SLAP_VIDEOS=["/src/assets/SlapKirkApp/kirkslap/kirkslap1.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap2.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap3.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap4.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap5.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap6.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap7.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap8.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap9.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap10.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap11.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap12.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap13.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap14.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap15.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap16.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap17.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap18.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap19.webm","/src/assets/SlapKirkApp/kirkslap/kirkslap20.webm"];static SPOCK_SLAP_FRAMES=["/src/assets/SlapKirkApp/spockslap/spockslap1.webp","/src/assets/SlapKirkApp/spockslap/spockslap2.webp","/src/assets/SlapKirkApp/spockslap/spockslap3.webp","/src/assets/SlapKirkApp/spockslap/spockslap4.webp","/src/assets/SlapKirkApp/spockslap/spockslap5.webp","/src/assets/SlapKirkApp/spockslap/spockslap6.webp","/src/assets/SlapKirkApp/spockslap/spockslap7.webp","/src/assets/SlapKirkApp/spockslap/spockslap8.webp","/src/assets/SlapKirkApp/spockslap/spockslap9.webp","/src/assets/SlapKirkApp/spockslap/spockslap10.webp","/src/assets/SlapKirkApp/spockslap/spockslap11.webp","/src/assets/SlapKirkApp/spockslap/spockslap12.webp","/src/assets/SlapKirkApp/spockslap/spockslap13.webp","/src/assets/SlapKirkApp/spockslap/spockslap14.webp","/src/assets/SlapKirkApp/spockslap/spockslap15.webp","/src/assets/SlapKirkApp/spockslap/spockslap16.webp","/src/assets/SlapKirkApp/spockslap/spockslap17.webp","/src/assets/SlapKirkApp/spockslap/spockslap18.webp","/src/assets/SlapKirkApp/spockslap/spockslap19.webp","/src/assets/SlapKirkApp/spockslap/spockslap20.webp"];static getRandomKirkSlapVideo(){const t=Math.floor(Math.random()*this.KIRK_SLAP_VIDEOS.length);return this.KIRK_SLAP_VIDEOS[t]}static getSpockSlapFrames(){return[...this.SPOCK_SLAP_FRAMES]}static getAllKirkSlapVideos(){return[...this.KIRK_SLAP_VIDEOS]}}class B{canvas;ctx;animationId=null;isPlaying=!1;currentAnimation=null;frameIndex=0;frameImages=[];video=null;particles=[];lastFrameTime=0;frameInterval=1e3/24;onComplete;constructor(t){this.canvas=t;const s=t.getContext("2d");if(!s)throw new Error("无法获取Canvas 2D上下文");this.ctx=s,this.setupCanvas()}setupCanvas(){this.canvas.style.position="absolute",this.canvas.style.top="0",this.canvas.style.left="0",this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.pointerEvents="none";const t=window.devicePixelRatio||1,s=this.canvas.getBoundingClientRect();this.canvas.width=s.width*t,this.canvas.height=s.height*t,this.ctx.scale(t,t)}async playVideoAnimation(t,s){return this.stop(),this.currentAnimation=t,this.onComplete=s,this.video=document.createElement("video"),this.video.src=t.videoPath,this.video.muted=!0,this.video.loop=t.loop||!1,new Promise((e,a)=>{if(!this.video)return a(new Error("视频创建失败"));this.video.onloadeddata=()=>{this.video&&(this.video.play(),this.startVideoRender(),e())},this.video.onerror=()=>a(new Error("视频加载失败")),this.video.onended=()=>{t.loop||(this.stop(),this.onComplete?.())}})}async playFrameAnimation(t,s){this.stop(),this.currentAnimation=t,this.onComplete=s,this.frameIndex=0,this.frameInterval=1e3/(t.frameRate||24),this.frameImages=[];const e=t.framePaths.map((a,i)=>new Promise((n,r)=>{const p=new Image;p.onload=()=>{this.frameImages[i]=p,n()},p.onerror=()=>r(new Error(`帧 ${i} 加载失败: ${a}`)),p.src=a}));try{await Promise.all(e),this.startFrameRender()}catch(a){console.error("帧动画加载失败:",a)}}playParticleEffect(t,s){this.stop(),this.currentAnimation=t,this.onComplete=s,this.particles=[];const{particleConfig:e}=t;for(let a=0;a<e.count;a++)this.particles.push({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,vx:(Math.random()-.5)*(e.velocity.max-e.velocity.min)+e.velocity.min,vy:(Math.random()-.5)*(e.velocity.max-e.velocity.min)+e.velocity.min,size:Math.random()*(e.size.max-e.size.min)+e.size.min,color:e.colors[Math.floor(Math.random()*e.colors.length)],life:e.lifetime,maxLife:e.lifetime});this.startParticleRender()}startVideoRender(){this.isPlaying=!0;const t=()=>{if(!(!this.isPlaying||!this.video)){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.video.readyState>=2){const{width:s,height:e}=this.canvas;this.ctx.drawImage(this.video,0,0,s,e)}this.animationId=requestAnimationFrame(t)}};t()}startFrameRender(){this.isPlaying=!0,this.lastFrameTime=performance.now();const t=s=>{if(!this.isPlaying)return;if(s-this.lastFrameTime>=this.frameInterval){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.frameImages[this.frameIndex]){const{width:a,height:i}=this.canvas;this.ctx.drawImage(this.frameImages[this.frameIndex],0,0,a,i)}if(this.frameIndex++,this.frameIndex>=this.frameImages.length)if(this.currentAnimation?.loop)this.frameIndex=0;else{this.stop(),this.onComplete?.();return}this.lastFrameTime=s}this.animationId=requestAnimationFrame(t)};t(performance.now())}startParticleRender(){this.isPlaying=!0;const t=()=>{if(this.isPlaying){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(let s=this.particles.length-1;s>=0;s--){const e=this.particles[s];if(e.x+=e.vx,e.y+=e.vy,e.life--,e.life<=0){this.particles.splice(s,1);continue}const a=e.life/e.maxLife;this.ctx.save(),this.ctx.globalAlpha=a,this.ctx.fillStyle=e.color,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size,0,Math.PI*2),this.ctx.fill(),this.ctx.restore()}if(this.particles.length===0){this.stop(),this.onComplete?.();return}this.animationId=requestAnimationFrame(t)}};t()}stop(){this.isPlaying=!1,this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.video&&(this.video.pause(),this.video=null),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.currentAnimation=null,this.frameIndex=0,this.frameImages=[],this.particles=[]}pause(){this.isPlaying=!1,this.video&&this.video.pause()}resume(){this.currentAnimation&&(this.isPlaying=!0,this.video?(this.video.play(),this.startVideoRender()):this.frameImages.length>0?this.startFrameRender():this.particles.length>0&&this.startParticleRender())}getCanvas(){return this.canvas}getContext(){return this.ctx}isAnimationPlaying(){return this.isPlaying}destroy(){this.stop()}}class U{audioElements=new Map;masterVolume=.7;enabled=!0;constructor(){this.preloadSounds()}async preloadSounds(){try{for(let t=1;t<=5;t++){const s=`/src/assets/SlapKirkApp/kirkgrunt/kirkgrunt${t}.webm`;await this.loadSound(`kirkgrunt${t}`,s,{preload:!0})}console.log("声音预加载完成")}catch(t){console.warn("声音预加载失败:",t)}}async loadSound(t,s,e={}){if(this.audioElements.has(t))return this.audioElements.get(t);const a=new Audio;return a.src=s,a.volume=(e.volume||1)*this.masterVolume,a.loop=e.loop||!1,e.preload&&(a.preload="auto"),new Promise((i,n)=>{a.addEventListener("canplaythrough",()=>{this.audioElements.set(t,a),i(a)}),a.addEventListener("error",r=>{console.warn(`音频加载失败: ${s}`,r),n(r)}),a.load()})}async playSound(t,s,e={}){if(this.enabled)try{let a;if(this.audioElements.has(t))a=this.audioElements.get(t);else if(s)a=await this.loadSound(t,s,e);else{console.warn(`声音 ${t} 未找到且未提供路径`);return}a.currentTime=0,a.volume=(e.volume||1)*this.masterVolume,await a.play()}catch(a){console.warn(`播放声音失败: ${t}`,a)}}async playRandomKirkGrunt(){const t=Math.floor(Math.random()*24)+1,s=`kirkgrunt${t}`,e=`/src/assets/SlapKirkApp/kirkgrunt/kirkgrunt${t}.webm`;await this.playSound(s,e,{volume:.8})}stopSound(t){const s=this.audioElements.get(t);s&&(s.pause(),s.currentTime=0)}stopAllSounds(){this.audioElements.forEach(t=>{t.pause(),t.currentTime=0})}setMasterVolume(t){this.masterVolume=Math.max(0,Math.min(1,t)),this.audioElements.forEach(s=>{s.volume=s.volume*this.masterVolume})}getMasterVolume(){return this.masterVolume}setEnabled(t){this.enabled=t,t||this.stopAllSounds()}isEnabled(){return this.enabled}destroy(){this.stopAllSounds(),this.audioElements.clear()}}const z=new U;var D=(o=>(o.BACKGROUND="background",o.ANIMATION="animation",o.HAND_DEBUG="hand_debug",o.UI_OVERLAY="ui_overlay",o))(D||{});class E{container;layers=new Map;animationSystem=null;static HAND_CONNECTIONS=[{from:0,to:1},{from:1,to:2},{from:2,to:3},{from:3,to:4},{from:0,to:5},{from:5,to:6},{from:6,to:7},{from:7,to:8},{from:0,to:9},{from:9,to:10},{from:10,to:11},{from:11,to:12},{from:0,to:13},{from:13,to:14},{from:14,to:15},{from:15,to:16},{from:0,to:17},{from:17,to:18},{from:18,to:19},{from:19,to:20},{from:5,to:9},{from:9,to:13},{from:13,to:17}];static DEFAULT_HAND_CONFIG={showLandmarks:!0,showConnections:!0,landmarkColor:"#FF6B6B",connectionColor:"#4ECDC4",landmarkSize:4,connectionWidth:2,showLabels:!1,labelColor:"#FFFFFF",labelFont:"12px Arial"};constructor(t){this.container=t,this.setupContainer(),this.initializeLayers()}setupContainer(){this.container.style.position="relative",this.container.style.width="100%",this.container.style.height="100%",this.container.style.overflow="hidden"}initializeLayers(){this.createLayer("background",1);const t=this.createLayer("animation",2);this.animationSystem=new B(t.canvas),this.createLayer("hand_debug",3),this.createLayer("ui_overlay",4)}createLayer(t,s){const e=document.createElement("canvas"),a=e.getContext("2d");if(!a)throw new Error(`无法创建${t}层的Canvas上下文`);e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.zIndex=s.toString(),e.style.pointerEvents="none",this.setupHighDPI(e,a),this.container.appendChild(e);const i={id:t,type:t,canvas:e,ctx:a,zIndex:s,visible:!0,alpha:1};return this.layers.set(t,i),i}setupHighDPI(t,s){const e=window.devicePixelRatio||1,a=this.container.getBoundingClientRect();t.width=a.width*e,t.height=a.height*e,s.scale(e,e),t.style.width=`${a.width}px`,t.style.height=`${a.height}px`}getLayer(t){return this.layers.get(t)||null}setLayerVisible(t,s){const e=this.layers.get(t);e&&(e.visible=s,e.canvas.style.display=s?"block":"none")}setLayerAlpha(t,s){const e=this.layers.get(t);e&&(e.alpha=Math.max(0,Math.min(1,s)),e.canvas.style.opacity=e.alpha.toString())}clearLayer(t){const s=this.layers.get(t);s&&s.ctx.clearRect(0,0,s.canvas.width,s.canvas.height)}clearAllLayers(){this.layers.forEach(t=>{t.ctx.clearRect(0,0,t.canvas.width,t.canvas.height)})}async playAnimation(t,s){if(!this.animationSystem)throw new Error("动画系统未初始化");try{switch(t.type){case"video":t.videoPath&&await this.animationSystem.playVideoAnimation(t,s);break;case"frames":t.framePaths&&await this.animationSystem.playFrameAnimation(t,s);break;case"particles":t.particleConfig&&this.animationSystem.playParticleEffect(t,s);break;default:console.warn("不支持的动画类型:",t.type)}}catch(e){console.error("动画播放失败:",e),s?.()}}stopAnimation(){this.animationSystem&&this.animationSystem.stop()}drawHandLandmarks(t,s={},e,a){const i=this.layers.get("hand_debug");if(!i||!i.visible)return;const n=i.ctx,r={...E.DEFAULT_HAND_CONFIG,...s};if(this.clearLayer("hand_debug"),t.length===0)return;const p=e||i.canvas.width/(window.devicePixelRatio||1),u=a||i.canvas.height/(window.devicePixelRatio||1);n.save(),r.showConnections&&(n.strokeStyle=r.connectionColor,n.lineWidth=r.connectionWidth,n.lineCap="round",E.HAND_CONNECTIONS.forEach(f=>{const d=t[f.from],c=t[f.to];d&&c&&(n.beginPath(),n.moveTo(d.x*p,d.y*u),n.lineTo(c.x*p,c.y*u),n.stroke())})),r.showLandmarks&&(n.fillStyle=r.landmarkColor,t.forEach((f,d)=>{const c=f.x*p,g=f.y*u;n.beginPath(),n.arc(c,g,r.landmarkSize,0,Math.PI*2),n.fill(),r.showLabels&&(n.fillStyle=r.labelColor,n.font=r.labelFont,n.textAlign="center",n.fillText(d.toString(),c,g-r.landmarkSize-2),n.fillStyle=r.landmarkColor)})),n.restore()}drawGestureInfo(t,s,e={x:10,y:30}){const a=this.layers.get("ui_overlay");if(!a||!a.visible)return;const i=a.ctx;this.clearLayer("ui_overlay"),i.save(),i.fillStyle="rgba(0, 0, 0, 0.7)",i.roundRect(e.x-5,e.y-25,200,50,5),i.fill(),i.fillStyle="#FFFFFF",i.font="bold 16px Arial",i.fillText(`手势: ${t}`,e.x,e.y),i.font="14px Arial",i.fillText(`置信度: ${(s*100).toFixed(1)}%`,e.x,e.y+20);const n=150,r=4,p=e.x+5,u=e.y+25;i.fillStyle="rgba(255, 255, 255, 0.3)",i.fillRect(p,u,n,r);const f=s>.7?"#4CAF50":s>.4?"#FF9800":"#F44336";i.fillStyle=f,i.fillRect(p,u,n*s,r),i.restore()}drawDebugGrid(t=50){const s=this.layers.get("background");if(!s)return;const e=s.ctx,a=s.canvas.width/(window.devicePixelRatio||1),i=s.canvas.height/(window.devicePixelRatio||1);e.save(),e.strokeStyle="rgba(255, 255, 255, 0.1)",e.lineWidth=1;for(let n=0;n<=a;n+=t)e.beginPath(),e.moveTo(n,0),e.lineTo(n,i),e.stroke();for(let n=0;n<=i;n+=t)e.beginPath(),e.moveTo(0,n),e.lineTo(a,n),e.stroke();e.restore()}resize(){this.layers.forEach(t=>{this.setupHighDPI(t.canvas,t.ctx)})}getAnimationSystem(){return this.animationSystem}getDebugCanvas(){const t=this.layers.get("hand_debug");return t?t.canvas:null}destroy(){this.animationSystem&&(this.animationSystem.destroy(),this.animationSystem=null),this.layers.forEach(t=>{t.canvas.parentNode&&t.canvas.parentNode.removeChild(t.canvas)}),this.layers.clear()}}const W="_gameContainer_1qj8s_1",Y="_header_1qj8s_34",J="_title_1qj8s_44",X="_headerControls_1qj8s_50",Z="_controlButton_1qj8s_54",Q="_gameArea_1qj8s_73",tt="_leftPanel_1qj8s_81",et="_rightPanel_1qj8s_88",st="_animationView_1qj8s_97",at="_debugLabel_1qj8s_122",it="_gestureIndicator_1qj8s_168",nt="_gestureEmoji_1qj8s_177",ot="_gestureText_1qj8s_182",rt="_confidenceBar_1qj8s_188",lt="_confidenceFill_1qj8s_196",ct="_kirkAvatar_1qj8s_202",ht="_slapped_1qj8s_211",dt="_kirkFace_1qj8s_214",pt="_kirkContainer_1qj8s_219",ut="_kirkDefault_1qj8s_234",mt="_slapEffect_1qj8s_237",ft="_spockDefault_1qj8s_243",gt="_gameStatus_1qj8s_315",xt="_loadingText_1qj8s_318",yt="_startButton_1qj8s_323",kt="_pausedText_1qj8s_342",vt="_manualSlapButton_1qj8s_356",St="_statsPanel_1qj8s_370",bt="_statItem_1qj8s_378",wt="_statLabel_1qj8s_381",At="_statValue_1qj8s_387",Ft="_combo_1qj8s_393",h={gameContainer:W,header:Y,title:J,headerControls:X,controlButton:Z,gameArea:Q,leftPanel:tt,rightPanel:et,animationView:st,debugLabel:at,gestureIndicator:it,gestureEmoji:nt,gestureText:ot,confidenceBar:rt,confidenceFill:lt,kirkAvatar:ct,slapped:ht,kirkFace:dt,kirkContainer:pt,kirkDefault:ut,slapEffect:mt,spockDefault:ft,gameStatus:gt,loadingText:xt,startButton:yt,pausedText:kt,manualSlapButton:vt,statsPanel:St,statItem:bt,statLabel:wt,statValue:At,combo:Ft},Dt=({isBeingSlapped:o,slapIntensity:t})=>{const s=m.useRef(null),e=m.useRef(null),[a,i]=m.useState(!1);return m.useEffect(()=>{s.current&&!e.current&&(e.current=new E(s.current))},[]),m.useEffect(()=>{if(o&&!a&&e.current){i(!0);const n=P.getRandomKirkSlapVideo();e.current.playAnimation({type:"video",videoPath:n,loop:!1,autoplay:!0},()=>{i(!1),e.current&&e.current.stopAnimation()}),z.playRandomKirkGrunt()}},[o,t,a]),m.useEffect(()=>()=>{e.current&&(e.current.destroy(),e.current=null)},[]),l.jsxs("div",{className:`${h.kirkAvatar} ${o?h.slapped:""}`,children:[l.jsx("div",{ref:s,className:h.kirkContainer,style:{position:"relative",width:"100%",height:"100%"},children:!a&&l.jsx("div",{className:h.kirkFace,children:l.jsx("div",{className:h.kirkDefault,children:"🖖"})})}),o&&l.jsx("div",{className:h.slapEffect,children:"💥"})]})},_t=({stats:o,gameLogic:t})=>l.jsxs("div",{className:h.statsPanel,children:[l.jsxs("div",{className:h.statItem,children:[l.jsx("span",{className:h.statLabel,children:"扇击次数"}),l.jsx("span",{className:h.statValue,children:o.totalSlaps})]}),l.jsxs("div",{className:h.statItem,children:[l.jsx("span",{className:h.statLabel,children:"连击"}),l.jsxs("span",{className:`${h.statValue} ${o.currentCombo>0?h.combo:""}`,children:[o.currentCombo>0&&"🔥"," ",o.currentCombo]})]}),l.jsxs("div",{className:h.statItem,children:[l.jsx("span",{className:h.statLabel,children:"最高连击"}),l.jsx("span",{className:h.statValue,children:o.maxCombo})]}),l.jsxs("div",{className:h.statItem,children:[l.jsx("span",{className:h.statLabel,children:"游戏时长"}),l.jsx("span",{className:h.statValue,children:t.formatTime(o.sessionTime)})]})]}),Et=({currentGesture:o,confidence:t,isAIReady:s})=>{const a=(()=>{if(!s)return{emoji:"🤖",text:"AI加载中...",color:"#666"};switch(o){case w.READY:return{emoji:"✋",text:"准备中",color:"#4CAF50"};case w.SLAP:return{emoji:"👋",text:"扇击!",color:"#FF5722"};case w.FIST:return{emoji:"✊",text:"拳头",color:"#FF9800"};case w.PEACE:return{emoji:"✌️",text:"特殊技能",color:"#9C27B0"};default:return{emoji:"👁️",text:"等待手势...",color:"#2196F3"}}})();return l.jsxs("div",{className:h.gestureIndicator,children:[l.jsx("div",{className:h.gestureEmoji,children:a.emoji}),l.jsx("div",{className:h.gestureText,style:{color:a.color},children:a.text}),s&&l.jsx("div",{className:h.confidenceBar,children:l.jsx("div",{className:h.confidenceFill,style:{width:`${t*100}%`,backgroundColor:a.color}})})]})},Ct=({debugMode:o,gestureEngine:t,showSpockSlap:s,onSpockSlapComplete:e})=>{const a=m.useRef(null),i=m.useRef(null),[n,r]=m.useState("无"),[p,u]=m.useState(0);m.useEffect(()=>{a.current&&!i.current&&(i.current=new E(a.current),i.current.setLayerVisible(D.HAND_DEBUG,o),i.current.setLayerVisible(D.UI_OVERLAY,o))},[]),m.useEffect(()=>{if(s&&i.current){const d=P.getSpockSlapFrames();i.current.playAnimation({type:"frames",framePaths:d,frameRate:24,loop:!0},e)}else!s&&i.current&&i.current.stopAnimation()},[s,e]),m.useEffect(()=>{i.current&&(i.current.setLayerVisible(D.HAND_DEBUG,o),i.current.setLayerVisible(D.UI_OVERLAY,o),o?i.current.drawDebugGrid(50):i.current.clearLayer(D.BACKGROUND))},[o]),m.useEffect(()=>{if(!t||!i.current||!o)return;const d=t.getDebugCanvas();if(d){const c=i.current.getLayer(D.HAND_DEBUG);if(c){const x=setInterval(()=>{if(!(!c||!d)){c.ctx.clearRect(0,0,c.canvas.width,c.canvas.height);try{c.ctx.drawImage(d,0,0,c.canvas.width,c.canvas.height)}catch{}}},100);return()=>{clearInterval(x)}}}},[t,o]),m.useEffect(()=>()=>{i.current&&(i.current.destroy(),i.current=null)},[]);const f=m.useCallback(()=>{o&&(t.getAdvancedDebugMode()?(t.disableAdvancedDebug(),console.log("关闭高级调试模式")):(t.enableAdvancedDebug(),console.log("开启高级调试模式 - 显示手部关键点标签")))},[o,t]);return l.jsxs("div",{className:h.animationView,onDoubleClick:f,children:[l.jsx("div",{ref:a,style:{width:"100%",height:"100%",position:"relative"}}),o&&l.jsx("div",{className:h.debugLabel,children:"🔍 调试模式 - 显示手部关键点 (双击切换详细模式)"}),!s&&!o&&l.jsx("div",{className:h.spockDefault,children:l.jsx("img",{src:"/src/assets/SlapKirkApp/spockslap/spockslap1.webp",alt:"Spock"})})]})},Tt=()=>{const[o]=m.useState(()=>new q),[t]=m.useState(()=>new V),[s,e]=m.useState(k.LOADING),[a,i]=m.useState(o.getStats()),[n,r]=m.useState(w.NONE),[p,u]=m.useState(0),[f,d]=m.useState(!1),[c,g]=m.useState(0),[x,y]=m.useState(!1),[v,S]=m.useState(!1);m.useEffect(()=>((async()=>{console.log("开始初始化AI手势识别...");try{await t.initialize()?(e(k.READY),t.onGestureDetected=C=>{r(C.type),u(C.confidence),o.handleGesture(C)},await t.startDetection()):(console.error("AI引擎初始化失败"),e(k.READY))}catch(b){console.error("初始化错误:",b),e(k.READY)}})(),o.onStatsUpdate=b=>{i({...b})},o.onSlapEffect=b=>{y(!0),setTimeout(()=>{d(!0),g(b),setTimeout(()=>d(!1),100)},300)},o.onGameStateChange=b=>{e(b)},()=>{t.dispose()}),[o,t]);const _=m.useCallback(()=>{o.startSession()},[o]),j=m.useCallback(()=>{s===k.PLAYING?o.pauseGame():s===k.PAUSED&&o.resumeGame()},[s,o]),M=m.useCallback(()=>{o.resetAllData()},[o]),R=m.useCallback(()=>{const F=!v;console.log(`准备${F?"开启":"关闭"}调试模式...`),S(F),setTimeout(()=>{try{t.setDebugMode(F),console.log(`调试模式已${F?"开启":"关闭"}`)}catch(b){console.error("切换调试模式失败:",b),S(!F)}},50)},[v,t]),L=m.useCallback(()=>{const F={type:w.SLAP,confidence:1,velocity:{x:.2,y:.1,magnitude:.22}};o.handleGesture(F)},[o]);return l.jsxs("div",{className:h.gameContainer,children:[l.jsxs("div",{className:h.header,children:[l.jsx("div",{className:h.title,children:"🖖 AI Slap Kirk"}),l.jsxs("div",{className:h.headerControls,children:[l.jsx("button",{className:h.controlButton,onClick:R,title:v?"关闭调试模式":"开启调试模式",children:v?"🔍":"👁️"}),l.jsx("button",{className:h.controlButton,onClick:j,disabled:s===k.LOADING,children:s===k.PLAYING?"⏸️":"▶️"}),l.jsx("button",{className:h.controlButton,onClick:M,title:"重置数据",children:"🔄"})]})]}),l.jsxs("div",{className:h.gameArea,children:[l.jsxs("div",{className:h.leftPanel,children:[l.jsx(Ct,{debugMode:v,gestureEngine:t,showSpockSlap:x,onSpockSlapComplete:()=>y(!1)}),l.jsx(Et,{currentGesture:n,confidence:p,isAIReady:s!==k.LOADING})]}),l.jsxs("div",{className:h.rightPanel,children:[l.jsx(Dt,{isBeingSlapped:f,slapIntensity:c}),l.jsxs("div",{className:h.gameStatus,children:[s===k.LOADING&&l.jsx("div",{className:h.loadingText,children:"🤖 AI加载中..."}),s===k.READY&&l.jsx("button",{className:h.startButton,onClick:_,children:"🚀 开始游戏"}),s===k.PAUSED&&l.jsx("div",{className:h.pausedText,children:"⏸️ 游戏已暂停"})]}),s===k.PLAYING&&l.jsx("button",{className:h.manualSlapButton,onClick:L,title:"手动扇击（测试用）",children:"👋 手动扇击"})]})]}),l.jsx(_t,{stats:a,gameLogic:o})]})};class I extends G{static icon=A.icon;static name=A.name;static id=A.id;root=null;launch(){this.openWindow()}openWindow(){const t=H.ins.showWindow("",{title:A.name,icon:A.icon,x:A.defaultWindow.x||200,y:A.defaultWindow.y||100,width:A.defaultWindow.width,height:A.defaultWindow.height});this.root=N.createRoot(t.content),this.root.render(K.createElement(Tt)),this.windows.set(t.id,t),t.on(O.EventType.ON_CLOSE,this.onClickClose)}onClickClose=()=>{$.ins.exitApp(I)};onExit(){this.root&&(this.root.unmount(),this.root=null)}}export{I as SlapKirkApp};
