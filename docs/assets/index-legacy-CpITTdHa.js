System.register(["./vendor-legacy-B1AJtM7E.js"],(function(e,t){"use strict";var n,s,a,i,o,r,c,h,d,l,w,m,p,g,u,v,y,f,x,S,M,A,b,P,R,z,L;return{setters:[e=>{n=e.G,s=e.F,a=e.S,i=e.P,o=e.C,r=e.R,c=e.V,h=e.W,d=e.a,l=e.A,w=e.D,m=e.M,p=e.B,g=e.b,u=e.L,v=e.c,y=e.d,f=e.O,x=e.i,S=e.e,M=e.f,A=e.g,b=e.h,P=e.N,R=e.r,z=e.j,L=e.k}],execute:function(){var e=document.createElement("style");e.textContent="*{margin:0;padding:0}html,body{font-size:.24rem;width:100%;height:100%;-webkit-text-size-adjust:100%!important;-ms-text-size-adjust:100%!important;text-size-adjust:100%!important;-moz-text-size-adjust:100%!important;overflow:hidden}#app{width:100%;height:100%;position:relative;overflow:hidden}\n/*$vite$:1*/",document.head.appendChild(e);const j=""+new URL("game_map-DLxz9SvN.glb",t.meta.url).href;function k(e){return new Worker(""+new URL("navmesh-worker-D_d9yitz.js",t.meta.url).href,{type:"module",name:e?.name})}const C=new n;new s;class E{canvas;renderer;scene=(()=>new a)();camera=(()=>new i(75,window.innerWidth/window.innerHeight,.1,1e3))();mapScene;controls;player;playerAgent;navMesh;crowd;pathLine;clock=(()=>new o(!0))();constructor(e){this.canvas=e,this.start()}async start(){this.initScene(),await this.addMap(),await this.initNavMesh(),await this.initCrowd(),this.renderer.setAnimationLoop(this.onUpdate);const e=new r,t=new c;this.canvas.addEventListener("mousedown",(n=>{if(2!==n.button)return;const{clientX:s,clientY:a}=n,i=this.canvas.getBoundingClientRect();t.x=(s-i.left)/this.canvas.offsetWidth*2-1,t.y=-(a-i.top)/this.canvas.offsetHeight*2+1,e.setFromCamera(t,this.camera);const o=e.intersectObject(this.mapScene);if(o.length>0){const e=o[0].point;this.playerAgent.requestMoveTarget(e)}}))}initScene(){const e=this.renderer=new h({canvas:this.canvas,powerPreference:"high-performance",antialias:!0});e.setSize(window.innerWidth,window.innerHeight),e.setPixelRatio(window.devicePixelRatio),e.shadowMap.enabled=!0,e.shadowMap.type=d;const t=()=>{e.setSize(window.innerWidth,window.innerHeight),this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix()};t(),window.addEventListener("resize",t),this.camera.position.set(-10,20,15);const n=new l(16777215,2);this.scene.add(n);const s=new w(16777215,6);s.castShadow=!0,s.shadow.camera.top=100,s.shadow.camera.bottom=-100,s.shadow.camera.left=-100,s.shadow.camera.right=100,s.shadow.bias=-1e-4,s.shadow.mapSize.set(4096,4096),s.position.set(5,5,5),s.shadow.normalBias=.05,s.shadow.radius=100,s.position.set(50,200,50),this.scene.add(s),this.player=new m(new p(1,1,1),new g({color:16711680})),this.player.castShadow=!0,this.player.receiveShadow=!0,this.scene.add(this.player),this.pathLine=new u(new v,new y({color:255,linewidth:10})),this.scene.add(this.pathLine),this.controls=new f(this.camera,this.canvas),this.controls.target=this.player.position,this.controls.enableDamping=!0,this.controls.maxDistance=50,this.controls.enableZoom=!0,this.controls.enablePan=!0,this.controls.maxPolarAngle=Math.PI/2,this.controls.minPolarAngle=0}async addMap(){const e=await C.loadAsync(j);this.mapScene=e.scene,this.mapScene.scale.set(5,5,5),this.scene.add(e.scene),e.scene.traverse((e=>{e instanceof m&&(e.castShadow=!0,e.receiveShadow=!0)}))}initNavMesh=async()=>new Promise((async e=>{console.time("init recast"),await x(),console.timeEnd("init recast");const t=new k;t.onmessage=t=>{console.timeEnd("Generate NavMesh");const n=t.data;this.navMesh=S(n).navMesh;const s=new M;this.scene.add(s),s.clear(),s.drawNavMesh(this.navMesh),e()};const n=[];this.mapScene.traverse((e=>{e instanceof m&&n.push(e)}));const[s,a]=A(n);console.time("Generate NavMesh"),t.postMessage({positions:s,indices:a,config:{cs:.2,ch:.5,tileSize:64,walkableSlopeAngle:35,walkableHeight:1,walkableClimb:1,walkableRadius:1,maxEdgeLen:12,maxSimplificationError:1.3,minRegionArea:8,mergeRegionArea:20,maxVertsPerPoly:6,detailSampleDist:6,detailSampleMaxError:1}},[s.buffer,a.buffer])}));initCrowd=async()=>{this.crowd=new b(this.navMesh,{maxAgents:10,maxAgentRadius:1});const e=new P(this.navMesh),{success:t,status:n,randomPolyRef:s,randomPoint:a}=e.findRandomPointAroundCircle({x:0,y:0,z:0},2);this.playerAgent=this.crowd.addAgent(a,{radius:.5,height:1,maxSpeed:6,maxAcceleration:20,collisionQueryRange:.5,pathOptimizationRange:0,separationWeight:1})};onUpdate=()=>{const e=this.clock.getDelta();this.renderer.render(this.scene,this.camera),this.crowd?.update(e),this.playerAgent&&(this.player.position.copy(this.playerAgent.position()),this.updatePath()),this.controls.update()};updatePath(){const e=[this.playerAgent.position(),...this.playerAgent.corners()];this.pathLine.geometry.dispose(),this.pathLine.geometry=new v,this.pathLine.geometry.setFromPoints(e)}destroy(){this.renderer.dispose()}}function N(){const e=R.useRef(null),t=R.useRef(null);return R.useEffect((()=>(t.current=new E(e.current),()=>{t.current.destroy()})),[]),z.jsx("div",{className:"app",children:z.jsx("canvas",{className:"gameCanvas",ref:e})})}L(document.getElementById("root")).render(z.jsx(N,{}))}}}));
